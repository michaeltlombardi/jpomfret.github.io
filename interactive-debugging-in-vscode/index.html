<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I was browsing twitter the other day when a tweet about dbatools caught my eye (I use TweetDeck and so have a column for tweets that contain @PSdbatools).
https://twitter.com/way0utwest/status/1242891971473137666
A dbatools bug!! Oh no!
One of the reasons this caught my eye was that Iâ€™ve seen this error in my environment with that same command. I had discounted that it was a bug and figured it was instead something in my environment."><title>Interactive debugging in VSCode</title><link rel=canonical href=https://jpomfret.github.io/interactive-debugging-in-vscode/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Interactive debugging in VSCode"><meta property="og:description" content="I was browsing twitter the other day when a tweet about dbatools caught my eye (I use TweetDeck and so have a column for tweets that contain @PSdbatools).
https://twitter.com/way0utwest/status/1242891971473137666
A dbatools bug!! Oh no!
One of the reasons this caught my eye was that Iâ€™ve seen this error in my environment with that same command. I had discounted that it was a bug and figured it was instead something in my environment."><meta property="og:url" content="https://jpomfret.github.io/interactive-debugging-in-vscode/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="debugging"><meta property="article:tag" content="powershell"><meta property="article:tag" content="vscode"><meta property="article:published_time" content="2020-04-07T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-07T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Interactive debugging in VSCode"><meta name=twitter:description content="I was browsing twitter the other day when a tweet about dbatools caught my eye (I use TweetDeck and so have a column for tweets that contain @PSdbatools).
https://twitter.com/way0utwest/status/1242891971473137666
A dbatools bug!! Oh no!
One of the reasons this caught my eye was that Iâ€™ve seen this error in my environment with that same command. I had discounted that it was a bug and figured it was instead something in my environment."><script async src="https://www.googletagmanager.com/gtag/js?id=G-YL15E7BXXF"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YL15E7BXXF",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/dbatools/>dbatools</a>
<a href=/categories/powershell/>powershell</a>
<a href=/categories/vscode/>vscode</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/interactive-debugging-in-vscode/>Interactive debugging in VSCode</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Apr 07, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><p>I was browsing twitter the other day when a tweet about dbatools caught my eye (I use <a class=link href=https://tweetdeck.twitter.com/ target=_blank rel=noopener>TweetDeck</a> and so have a column for tweets that contain <a class=link href=http://twitter.com/psdbatools target=_blank rel=noopener>@PSdbatools</a>).</p><p><a class=link href=https://twitter.com/way0utwest/status/1242891971473137666 target=_blank rel=noopener>https://twitter.com/way0utwest/status/1242891971473137666</a></p><p>A dbatools bug!! Oh no!</p><p>One of the reasons this caught my eye was that Iâ€™ve seen this error in my environment with that same command. I had discounted that it was a bug and figured it was instead something in my environment. I presumed it was something related to the fact I was using containers and Azure Data Studio connections.</p><p>Step one for dbatools bug fixing is to check for an issue on the <a class=link href=http://dbatools.io/bugs target=_blank rel=noopener>GitHub repo</a> and create one if there isnâ€™t one already. It turned out that there was <a class=link href=https://github.com/sqlcollaborative/dbatools/issues/6292 target=_blank rel=noopener>one already created</a> so weâ€™re covered there.</p><p>So I figured Iâ€™d take a look and see what was happening and how we could fix it. Now Iâ€™m going to be honest with you, my usual method of debugging involves adding <code>Write-Host 'Hi</code>&rsquo;, or piping objects to <code>Out-GridView</code>. I did start down this route, but the <code>Get-DbaRegServer</code> function calls an internal function, and things quickly got complicated.</p><p>Luckily, the <a class=link href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.PowerShell" target=_blank rel=noopener>PowerShell extension for VSCode</a> includes a debugger so we can level up our game and use that to track down our issues. Since I havenâ€™t already used this for my dbatools folder when I click the â€˜Runâ€™ icon on the left navigation bar I see the following:</p><p><img src=/images/startDebug.jpg loading=lazy alt="run and debug window in VSCode"></p><p>Pressing the â€˜Run and Debugâ€™ button will run your active file and, if you have breakpoints set up, then itâ€™ll break at those points for you to troubleshoot. This is really useful if you have written a script and itâ€™s not working correctly. Since Iâ€™m troubleshooting the call of a function I could write a simple script with the code to call the function, save it and then press â€˜Run and Debugâ€™. However there is another option, and that is to launch an interactive debugger.Â </p><p>Pressing the â€˜create a launch.json fileâ€™ link opens the command palette with the option to choose your PowerShell debug configuration. Choosing the â€˜Interactive Sessionâ€™ configuration means we can use the integrated console within VSCode to call functions and launch the debugger.</p><p><img src=/images/debugConfig.jpg loading=lazy alt="Select a PowerShell debug configuration"></p><p>This will open a launch.json file that you can edit to add more functionality and customization, but weâ€™ll just save it as is right now.</p><p>{
// Use IntelliSense to learn about possible attributes.
// Hover to view descriptions of existing attributes.
// For more information, visit: <a class=link href="https://go.microsoft.com/fwlink/?linkid=830387" target=_blank rel=noopener>https://go.microsoft.com/fwlink/?linkid=830387</a>
&ldquo;version&rdquo;: &ldquo;0.2.0&rdquo;,
&ldquo;configurations&rdquo;: [
{
&ldquo;name&rdquo;: &ldquo;PowerShell: Interactive Session&rdquo;,
&ldquo;type&rdquo;: &ldquo;PowerShell&rdquo;,
&ldquo;request&rdquo;: &ldquo;launch&rdquo;,
&ldquo;cwd&rdquo;: ""
}
]
}</p><p>As soon as you save it the left â€˜Run and Debugâ€™ pane will change to look like this. Now weâ€™re ready to run the interactive debugger by pressing the green play button or F5.</p><p><img src=/images/DebugInteractive.jpg loading=lazy alt="Debug and Run window for PowerShell extension"></p><p>So now that weâ€™re set up, letâ€™s start troubleshooting.</p><p>Step one is to reproduce this issue. This particular bug was easy to reproduce. The only requirements are that you have Azure Data Studio installed and at least one connection set up, then just running <code>Get-DbaRegServer</code> caused the error.</p><p>Next we need to add some breakpoints. These need to be the positions in the code where you want to stop execution and take a look at how things are set in the moment. Itâ€™s also a great way to see if you entered certain sections of the code that may be guarded by conditional logic.</p><p>Running <code>Get-DbaRegServer</code> in the integrated console you can see the error, even down to the line from the function where the error is being thrown. In the screenshot below you can see hovering over that line in VSCode allows you to follow the link to open the function and navigate to the exact line.</p><p><img src=/images/GetDbaRegServerError.jpg loading=lazy alt="Get-DbaRegServer throws an error"></p><p>Line 180 of the Get-DbaRegServer is the following:</p><p>$tempserver.ConnectionString = $adsconn.ConnectionString</p><p>Weâ€™ll insert a breakpoint here by clicking in the gutter at line 180.</p><p><img src=/images/addBreakpoint.jpg loading=lazy></p><p>Now pressing F5 the interactive debugger will start, and we can rerun <code>Get-DbaRegServer</code> in the interactive console. When we do that as soon as the execution gets to line 180 the code will stop, waiting for us to respond.</p><p>You can see below that we are able to find the <code>$adsconn</code> variable in the variables pane on the left and see that itâ€™s actually an object with three values â€“ which is the issue here â€“ weâ€™re expecting to only have one returned.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2020/04/breakpoint.jpg target=_blank rel=noopener><img src="https://i2.wp.com/jesspomfret.com/wp-content/uploads/2020/04/breakpoint.jpg?fit=650%2C246&ssl=1" loading=lazy alt="VSCode code stopped at breakpoint, displaying variables"></a></p><p>I read back through the <code>Get-DbaRegServer</code> function to find where the <code>$adsconn</code> variable was set and found it was from calling the internal function <code>Get-ADSConnection</code>. I added in another breakpoint within that function to dig in deeper.</p><p>Adding the breakpoint within the second function means that when we call <code>Get-RegServer</code> and then that calls <code>Get-ADSConnection</code> the code will wait within the second function and allow you to inspect variables within that function.</p><p>This meant that I was able to determine that there were several connection strings being returned for each server and that we needed to filter down to one.</p><p>Changing line 174 in the <code>Get-DbaRegServer</code> function to include an additional filter, shown below, meant that only one connection string was returned and solved the problem.</p><p>$adsconn = $adsconnection | Where-Object { $_.server -eq $server.Options[&lsquo;server&rsquo;] -and -not $_.database }</p><p>Hopefully this walkthrough shows a useful way of using the interactive debugger to hunt down bugs.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/dbatools/>dbatools</a>
<a href=/tags/debugging/>debugging</a>
<a href=/tags/powershell/>powershell</a>
<a href=/tags/vscode/>vscode</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/log-ship-staged/><div class=article-image><img src=/log-ship-staged/cover.f4ab6d164035c79e896561924d558d00_hufa84d3a6e624ae2b3ca125fbcc0da73a_679878_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Log Shipping â€“ Pre-stage database backups with dbatools" data-key=log-ship-staged data-hash="md5-9KttFkA1x56JZWGSTVWNAA=="></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article><article><a href=/collating-index-usage-stats-across-availability-group-replicas/><div class=article-details><h2 class=article-title>Collating index usage stats across Availability Group replicas</h2></div></a></article><article><a href=/searching-stored-procedures-for-a-pattern-made-easy-with-dbatools/><div class=article-details><h2 class=article-title>Searching Stored Procedures for a pattern made easy with dbatools</h2></div></a></article><article><a href=/quickly-execute-a-folder-of-sql-scripts-against-a-sql-server/><div class=article-details><h2 class=article-title>Quickly Execute a Folder of SQL Scripts against a SQL Server</h2></div></a></article><article><a href=/troubleshooting-spn-troubles-cannot-generate-sspi-context/><div class=article-details><h2 class=article-title>Troubleshooting SPN Troubles - Cannot generate SSPI context</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>