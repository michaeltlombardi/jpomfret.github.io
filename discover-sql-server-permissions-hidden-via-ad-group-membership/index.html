<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="When granting permissions to SQL Server resources we have a few options. One option is to grant permissions to Active Directory groups instead of individual users.Â This has several benefits, for example, improved security over using SQL logins, and the ability to create a separation of duties when controlling database access.
However, it does add an extra step when trying to determine who has what access to your SQL Servers. It can also make troubleshooting permission issues more challenging."><title>Discover SQL Server Permissions hidden via AD Group Membership</title><link rel=canonical href=https://jpomfret.github.io/discover-sql-server-permissions-hidden-via-ad-group-membership/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Discover SQL Server Permissions hidden via AD Group Membership"><meta property="og:description" content="When granting permissions to SQL Server resources we have a few options. One option is to grant permissions to Active Directory groups instead of individual users.Â This has several benefits, for example, improved security over using SQL logins, and the ability to create a separation of duties when controlling database access.
However, it does add an extra step when trying to determine who has what access to your SQL Servers. It can also make troubleshooting permission issues more challenging."><meta property="og:url" content="https://jpomfret.github.io/discover-sql-server-permissions-hidden-via-ad-group-membership/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="active-directory"><meta property="article:tag" content="activedirectory"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="permissions"><meta property="article:tag" content="powershell"><meta property="article:published_time" content="2021-01-26T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-26T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Discover SQL Server Permissions hidden via AD Group Membership"><meta name=twitter:description content="When granting permissions to SQL Server resources we have a few options. One option is to grant permissions to Active Directory groups instead of individual users.Â This has several benefits, for example, improved security over using SQL logins, and the ability to create a separation of duties when controlling database access.
However, it does add an extra step when trying to determine who has what access to your SQL Servers. It can also make troubleshooting permission issues more challenging."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#setup><strong>Setup</strong></a></li></ol><ol><li><a href=#viewing-database-access><strong>Viewing database access</strong></a></li><li><a href=#summary><strong>Summary</strong></a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/dbatools/>dbatools</a>
<a href=/categories/powershell/>powershell</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/discover-sql-server-permissions-hidden-via-ad-group-membership/>Discover SQL Server Permissions hidden via AD Group Membership</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 26, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>When granting permissions to SQL Server resources we have a few options. One option is to grant permissions to Active Directory groups instead of individual users.Â  This has several benefits, for example, improved security over using SQL logins, and the ability to create a separation of duties when controlling database access.</p><p>However, it does add an extra step when trying to determine who has what access to your SQL Servers. It can also make troubleshooting permission issues more challenging.Â  This post is going to aim to simplify this by combining dbatools and ActiveDirectory PowerShell modules to provide a clear solution.</p><h2 id=setup><strong>Setup</strong></h2><p>This is obviously not needed in our actual environments, this is just how I prepared my lab so I could demonstrate how we can solve this problem.Â  Feel free to skip ahead to the solution if you already have plenty of AD groups to investigate.</p><p>The full code sample is available in my <a class=link href=https://github.com/jpomfret/demos/blob/master/BlogExamples/07_PermisssionsGrantedViaADGroups.ps1 target=_blank rel=noopener>GitHub demos repo</a>.</p><p>First, I created some AD users and groups to use in my lab. This is easily achieved with the AD PowerShell module using <code>New-AdUser</code> and <code>New-AdGroup</code>. Then, using <code>Add-AdGroupMember</code>, I added two users into the newly created group.</p><p># setup - create some AD users\groups uing the ActiveDirectory module</p><h1 id=create-several-new-ad-users>create several new ad users</h1><p>(&lsquo;pomfretJ&rsquo;,&lsquo;smithA&rsquo;, &lsquo;jonesP&rsquo;,&lsquo;barnesR&rsquo;).foreach{New-AdUser $_}</p><h1 id=view-newly-created-users>view newly created users</h1><p>$date = (get-date).AddHours(-1)
get-aduser -filter {created -gt $date} | select name</p><h1 id=create-a-new-ad-group>create a new Ad group</h1><p>$newAdGroup = @{
Name = &lsquo;AdventureWorksReadOnly&rsquo;
GroupCategory = &lsquo;Security&rsquo;
GroupScope = &lsquo;Global&rsquo;
Path = &lsquo;CN=Users,DC=pomfret,DC=com&rsquo;
}
New-ADGroup @newAdGroup</p><h1 id=add-users-to-group>add users to group</h1><p>$addMemberGroup = @{
Identity = &lsquo;AdventureWorksReadOnly&rsquo;
Members = &lsquo;pomfretj&rsquo;, &lsquo;jonesP&rsquo;
}
Add-ADGroupMember @addMemberGroup</p><p>The second part of the setup was to add an AD group and an AD user to the SQL Server and grant some permissions using dbatools.</p><p># setup - grant permissions to ad users\groups using dbatools</p><h1 id=add-ad-group-and-grant-permissions-db_datareader-to-adventureworks>add ad group and grant permissions (db_datareader to AdventureWorks)</h1><p>New-DbaLogin -SqlInstance dscsvr1 -Login &lsquo;Pomfret\AdventureWorksReadOnly&rsquo;
New-DbaDbUser -SqlInstance dscsvr1 -Database AdventureWorks2017 -Login &lsquo;Pomfret\AdventureWorksReadOnly&rsquo;
Add-DbaDbRoleMember -SqlInstance dscsvr1 -Database AdventureWorks2017 -Role db_datareader -User &lsquo;Pomfret\AdventureWorksReadOnly&rsquo; -Confirm:$false</p><h1 id=add-ad-user-to-sql-server-and-provide-permissions-db_owner-to-adventureworks>add ad user to sql server and provide permissions (db_owner to AdventureWorks)</h1><p>New-DbaLogin -SqlInstance dscsvr1 -Login &lsquo;Pomfret\smithA&rsquo;
New-DbaDbUser -SqlInstance dscsvr1 -Database AdventureWorks2017 -Login &lsquo;Pomfret\smithA&rsquo;
Add-DbaDbRoleMember -SqlInstance dscsvr1 -Database AdventureWorks2017 -Role db_owner -User &lsquo;Pomfret\smithA&rsquo; -Confirm:$false</p><h2 id=viewing-database-access><strong>Viewing database access</strong></h2><p>Now that my lab environment is set up, letâ€™s take a look at database users that have access to the AdventureWorks2017 database.Â  This is an easy task thanks to dbatools, we can just use <code>Get-DbaDbUser</code>. Shown below, you can clearly see there is a WindowsUser &lsquo;smithA&rsquo; that has access, as well as a WindowsGroup &lsquo;AdventureWorksReadOnly&rsquo;.</p><p># Find users that have permissions through group membership
Get-DbaDbUser -SqlInstance dscsvr1 -Database AdventureWorks2017 -ExcludeSystemUser | Select-Object SqlInstance, Database, Login, LoginType, HasDbAccess</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/01/GetDbaDbUser.png target=_blank rel=noopener><img src=/images/GetDbaDbUser.png loading=lazy alt="Get-DbaDbUser results"></a></p><p>We can also use <code>Get-DbaDbRoleMember</code> to see exactly which database roles these users have been granted.Â </p><p>Get-DbaDbRoleMember -SqlInstance dscsvr1 -Database AdventureWorks2017 | Select-Object SqlInstance, Database, role, Login</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/01/Get-DbaDbRoleMember.png target=_blank rel=noopener><img src=/images/Get-DbaDbRoleMember.png loading=lazy alt="Get-DbaDbRoleMember output"></a></p><p>The issue is the same for both these examples, we donâ€™t know which users are inheriting the permissions granted to the &lsquo;AdventureWorksReadOnly&rsquo; group. This is where we need to combine these two modules to get the answers we need.</p><p>There are several ways you could combine the output of two functions. For this example Iâ€™m going to use a calculated property.</p><p>If I run the exact same code as before to get a list of role members from the dbatools function <code>Get-DbaDbRoleMember</code>, I can add a calculated property in the Select-Object to lookup the members of that specific group from active directory.Â  In the example below you can see the &lsquo;AdventureWorksReadOnly&rsquo; group has two members, and we now know that both &lsquo;pomfretJ&rsquo; and &lsquo;jonesP&rsquo; have read access to the AdventureWorks2017 database.Â </p><p>You can also still see the WindowsUser, &lsquo;smithA&rsquo;, has db_owner permissions.Â  Since that lookup didnâ€™t return any results (obviously, since itâ€™s a user not a group), the GroupMembers property remains empty.</p><p>Get-DbaDbRoleMember -SqlInstance dscsvr1 -Database AdventureWorks2017 |
Select-Object SqlInstance, Database, Role, LoginType, Login, @{l=&lsquo;GroupMembers&rsquo;;e={ (Get-AdGroupMember -Identity ($_.Login).Split(&rsquo;\&rsquo;)[1]).Name }}</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/01/FinalOutput.png target=_blank rel=noopener><img src=/images/FinalOutput.png loading=lazy alt="Combining Get-DbaDbRoleMember & Get-AdGroupMember"></a></p><p>You can also use this same code to determine specific user access, for example, by adding a Where-Object to see just the permissions granted to &lsquo;pomfretJ&rsquo;.</p><h2 id=summary><strong>Summary</strong></h2><p>This should give you an easy option for determining specific user access that is hidden behind AD groups, and I think reduces one of the negatives of using AD groups in this situation.Â  It also shows us that we can combine multiple functions into one to get all the information we need with one easy line of code.</p><p>I would also encourage you to explore the other permission related dbatools functions available, including <code>Get-DbaServerRole</code> and <code>Get-DbaPermission</code>. These can also be used in combination with <code>Get-AdGroupMember</code> to enhance the results.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/active-directory/>active-directory</a>
<a href=/tags/activedirectory/>activedirectory</a>
<a href=/tags/dbatools/>dbatools</a>
<a href=/tags/permissions/>permissions</a>
<a href=/tags/powershell/>powershell</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/log-ship-staged/><div class=article-image><img src=/log-ship-staged/cover.f4ab6d164035c79e896561924d558d00_hufa84d3a6e624ae2b3ca125fbcc0da73a_679878_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Log Shipping â€“ Pre-stage database backups with dbatools" data-key=log-ship-staged data-hash="md5-9KttFkA1x56JZWGSTVWNAA=="></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article><article><a href=/collating-index-usage-stats-across-availability-group-replicas/><div class=article-details><h2 class=article-title>Collating index usage stats across Availability Group replicas</h2></div></a></article><article><a href=/searching-stored-procedures-for-a-pattern-made-easy-with-dbatools/><div class=article-details><h2 class=article-title>Searching Stored Procedures for a pattern made easy with dbatools</h2></div></a></article><article><a href=/quickly-execute-a-folder-of-sql-scripts-against-a-sql-server/><div class=article-details><h2 class=article-title>Quickly Execute a Folder of SQL Scripts against a SQL Server</h2></div></a></article><article><a href=/troubleshooting-spn-troubles-cannot-generate-sspi-context/><div class=article-details><h2 class=article-title>Troubleshooting SPN Troubles - Cannot generate SSPI context</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>