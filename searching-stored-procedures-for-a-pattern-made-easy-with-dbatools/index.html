<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Well folks, after starting the year off on a strong foot itâ€™s been a while since Iâ€™ve published any blog posts. Hope you didnâ€™t miss me too much, but Iâ€™m back now and Iâ€™ve got a useful dbatools snippet for you today.Â Last week at the day job I had a situation where I needed to find all stored procedures that referenced a certain string, across any database on a specific server."><title>Searching Stored Procedures for a pattern made easy with dbatools</title><link rel=canonical href=https://jpomfret.github.io/searching-stored-procedures-for-a-pattern-made-easy-with-dbatools/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Searching Stored Procedures for a pattern made easy with dbatools"><meta property="og:description" content="Well folks, after starting the year off on a strong foot itâ€™s been a while since Iâ€™ve published any blog posts. Hope you didnâ€™t miss me too much, but Iâ€™m back now and Iâ€™ve got a useful dbatools snippet for you today.Â Last week at the day job I had a situation where I needed to find all stored procedures that referenced a certain string, across any database on a specific server."><meta property="og:url" content="https://jpomfret.github.io/searching-stored-procedures-for-a-pattern-made-easy-with-dbatools/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="powershell"><meta property="article:tag" content="stored-procedures"><meta property="article:published_time" content="2021-05-25T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-25T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Searching Stored Procedures for a pattern made easy with dbatools"><meta name=twitter:description content="Well folks, after starting the year off on a strong foot itâ€™s been a while since Iâ€™ve published any blog posts. Hope you didnâ€™t miss me too much, but Iâ€™m back now and Iâ€™ve got a useful dbatools snippet for you today.Â Last week at the day job I had a situation where I needed to find all stored procedures that referenced a certain string, across any database on a specific server."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#find-the-dbatools-command-for-the-job>Find the dbatools command for the job</a></li><li><a href=#sql-server-management-objects-smo>SQL Server Management Objects (SMO)</a></li><li><a href=#find-our-string-within-all-stored-procedures-in-any-database>Find our string within all Stored Procedures in any database</a></li><li><a href=#so-many-more-options>So many more optionsâ€¦</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/dbatools/>dbatools</a>
<a href=/categories/powershell/>powershell</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/searching-stored-procedures-for-a-pattern-made-easy-with-dbatools/>Searching Stored Procedures for a pattern made easy with dbatools</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>May 25, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><p>Well folks, after starting the year off on a strong foot itâ€™s been a while since Iâ€™ve published any blog posts. Hope you didnâ€™t miss me too much, but Iâ€™m back now and Iâ€™ve got a useful dbatools snippet for you today.Â  Last week at the day job I had a situation where I needed to find all stored procedures that referenced a certain string, across any database on a specific server.Â  This is a pretty trivial task in SSMS when youâ€™re just talking about one database. For example, if weâ€™re looking for any reference to â€˜Personâ€™ perhaps we could run this T-SQL within the context of the database:</p><p>select o.name, sc.text, o.type
from sys.objects o
inner join sys.syscomments sc
on sc.id = o.object_id
where text like &lsquo;%Person%&rsquo;
and o.type = &lsquo;P&rsquo; &ndash; filtered for just stored procedures</p><p>You can see Iâ€™ve found one procedure in my TestDb that references the â€˜Personâ€™ table, so it has been returned.</p><p><img src=/images/TSQL.jpg loading=lazy alt="T-SQL code to find procedures with &lsquo;person&rsquo; in"></p><p>However, if I want to search all databases on the server I now need to start thinking about a cursor, or using something like <code>sp_MSforeachdb</code> to iterate over the databases.Â  A quick warning here- <code>sp_MSforeachdb</code> is an undocumented procedure and there are some known issues with it.</p><p>The natural next step here when weâ€™re thinking about handling multiple databases is to switch to PowerShell and use dbatools.</p><h2 id=find-the-dbatools-command-for-the-job>Find the dbatools command for the job</h2><p>When weâ€™re looking for the command we need within dbatools to fulfil our needs I cannot recommend <code>Find-DbaCommand</code> highly enough.Â  This command will search all other commands for the pattern you pass in.Â  Today we know we want to find references in stored procedures so letâ€™s see if there is a command that will help.</p><p>Find-DbaCommand *stored*proc*</p><p><img src=/images/findCommand-1024x368.jpg loading=lazy alt="Find-DbaCommand helping us to find what we need"></p><p>Looks like <code>Get-DbaDbStoredProcedure</code> is what we need here.Â  Since this is our first time using this particular command I always have a quick look through the help content. I highly recommend running <code>Get-Help Get-DbaDbStoredProcedure -ShowWindow</code>, this will open a separate window from your console and allow you to keep that open to refer back to if needed.Â  The last section of the help gives us several examples on how to use this command- letâ€™s run a simple one against a test database to see what we get. Iâ€™m also going to pipe the output to <code>Select-Object</code> so I can just sample the first 2 results.</p><p>Get-DbaDbStoredProcedure -SqlInstance &rsquo;localhost,2500&rsquo; -Database testDb | Select-Object -First 2</p><p><img src=/images/twoProcs-1024x539.jpg loading=lazy alt="Get-DbaDbStoredProcedure results"></p><p>This is handy, but this output doesnâ€™t look like itâ€™s going to help answer the question and find references of a string within the stored procedure code. Thereâ€™s more than meets the eyes though.</p><h2 id=sql-server-management-objects-smo>SQL Server Management Objects (SMO)</h2><p>dbatools deals mostly with SQL Server Management Objects (SMO), which means that what you see in the output for commands is not always all there is available.Â  SMO is a hierarchy of objects which can be easily traversed from the output of the commands.Â  You can tell that weâ€™re dealing with SMO instead of standard PowerShell objects by using <code>Get-Member</code> and looking at the TypeName.</p><p>Get-DbaDbStoredProcedure -SqlInstance &rsquo;localhost,2500&rsquo; -Database testDb | Get-Member</p><p><img src=/images/getMember.jpg loading=lazy alt="using Get-Member to see what&rsquo;s available"></p><p><code>Get-Member</code> is also really useful for looking to see whatâ€™s available from the object that is returned. In the screenshot above you can see multiple methods that can be used. If you run this in your console youâ€™ll also get a list of all available properties.Â  Thatâ€™s a hint for what we need for our scenario.</p><h2 id=find-our-string-within-all-stored-procedures-in-any-database>Find our string within all Stored Procedures in any database</h2><p>Now that we know the <code>Get-DbaDbStoredProcedure</code> command is going to return SMO StoredProcedure objects we can look at some of the properties not returned by default.Â  We already saw one option for this- using <code>Get-Member</code> will list all the properties available to us.Â  Another option is to select all the properties for the first result.</p><p>Get-DbaDbStoredProcedure -SqlInstance &rsquo;localhost,2500&rsquo; -Database testDb | Select-Object -First 1 *</p><p><img src=/images/SelectAll-1024x315.png loading=lazy alt="Select all the properties from Get-DbaDbStoredProcedure"></p><p>In the output you can see there are a lot of properties available that werenâ€™t returned by default, this includes <code>TextBody</code> which is what we need to search for our reference string.Â  All we need to do now is pipe the output of the command through to <code>Where-Object</code> to find what we need:</p><p>Get-DbaDbStoredProcedure -SqlInstance &rsquo;localhost,2500&rsquo; -ExcludeSystemSp | Where-Object TextBody -like &lsquo;*Person*&rsquo;</p><p>Youâ€™ll notice two more changes to the code above. I dropped the <code>Database</code> parameter, opening the search up to the whole server. I also added <code>ExcludeSystemSp</code>, which means Iâ€™m only interested in user defined stored procedures. It is important to note if you have a lot of stored procedures this command could take a little while to run.</p><p><img src=/images/SearchAllSPs-1024x237.jpg loading=lazy alt="search the TextBody for key words"></p><p>PowerShell also supports other <a class=link href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_comparison_operators?view=powershell-7.1" target=_blank rel=noopener>comparison operators</a> by default, including `match` which can be used to find regex patterns within your procedures.Â  This opens up a lot more possibilities when looking for more complicated patterns within your database.</p><h2 id=so-many-more-options>So many more optionsâ€¦</h2><p>Today we were only looking for results on one SQL Server instance, but since dbatools makes handling multiple SQL instances easy we could also widen the search and instead search our entire estate for references to a certain string.</p><p>We also only looked at Stored Procedures today, but if you do a little research with <code>Find-DbaCommand</code>, <code>Get-Help</code> and <code>Get-Member</code> youâ€™ll soon find what you need to search through functions, views and more.</p><p>Happy searching!</p></section><footer class=article-footer><section class=article-tags><a href=/tags/dbatools/>dbatools</a>
<a href=/tags/powershell/>powershell</a>
<a href=/tags/stored-procedures/>stored-procedures</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/log-ship-staged/><div class=article-image><img src=/log-ship-staged/cover.f4ab6d164035c79e896561924d558d00_hufa84d3a6e624ae2b3ca125fbcc0da73a_679878_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Log Shipping â€“ Pre-stage database backups with dbatools" data-key=log-ship-staged data-hash="md5-9KttFkA1x56JZWGSTVWNAA=="></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article><article><a href=/collating-index-usage-stats-across-availability-group-replicas/><div class=article-details><h2 class=article-title>Collating index usage stats across Availability Group replicas</h2></div></a></article><article><a href=/quickly-execute-a-folder-of-sql-scripts-against-a-sql-server/><div class=article-details><h2 class=article-title>Quickly Execute a Folder of SQL Scripts against a SQL Server</h2></div></a></article><article><a href=/troubleshooting-spn-troubles-cannot-generate-sspi-context/><div class=article-details><h2 class=article-title>Troubleshooting SPN Troubles - Cannot generate SSPI context</h2></div></a></article><article><a href=/discover-sql-server-permissions-hidden-via-ad-group-membership/><div class=article-details><h2 class=article-title>Discover SQL Server Permissions hidden via AD Group Membership</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>