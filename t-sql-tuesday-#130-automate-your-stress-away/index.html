<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Thanks to Elizabeth Nobel (b|t) for hosting this monthâ€™s T-SQL Tuesday party and apologies for being as late as possible to the party! I love the topic of automation so felt sure Iâ€™d write something and then time slipped away. Luckily Mikey Bronowski (b|t) convinced me that it wasnâ€™t too late to write something on my lunch break today (Wednesday in the UK) as itâ€™s still Tuesday on Baker Island."><title>T-SQL Tuesday #130 â€“ Automate Your Stress Away</title><link rel=canonical href=https://jpomfret.github.io/t-sql-tuesday-#130-automate-your-stress-away/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="T-SQL Tuesday #130 â€“ Automate Your Stress Away"><meta property="og:description" content="Thanks to Elizabeth Nobel (b|t) for hosting this monthâ€™s T-SQL Tuesday party and apologies for being as late as possible to the party! I love the topic of automation so felt sure Iâ€™d write something and then time slipped away. Luckily Mikey Bronowski (b|t) convinced me that it wasnâ€™t too late to write something on my lunch break today (Wednesday in the UK) as itâ€™s still Tuesday on Baker Island."><meta property="og:url" content="https://jpomfret.github.io/t-sql-tuesday-#130-automate-your-stress-away/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="dbachecks"><meta property="article:tag" content="tsql2sday"><meta property="article:tag" content="tsqltuesday"><meta property="article:published_time" content="2020-09-09T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-09T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="T-SQL Tuesday #130 â€“ Automate Your Stress Away"><meta name=twitter:description content="Thanks to Elizabeth Nobel (b|t) for hosting this monthâ€™s T-SQL Tuesday party and apologies for being as late as possible to the party! I love the topic of automation so felt sure Iâ€™d write something and then time slipped away. Luckily Mikey Bronowski (b|t) convinced me that it wasnâ€™t too late to write something on my lunch break today (Wednesday in the UK) as itâ€™s still Tuesday on Baker Island."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#automating-dbachecks-with-scheduled-task>Automating dbachecks with scheduled task</a><ol><li><a href=#the-environment>The environment</a></li><li><a href=#the-checks>The checks</a></li><li><a href=#the-automation>The automation</a></li></ol></li><li><a href=#dbachecks-database-connection>Dbachecks Database Connection</a></li><li><a href=#define-instances-and-checks-to-run>Define instances and checks to run</a><ol><li><a href=#results>Results</a></li><li><a href=#summary>Summary</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/dbachecks/>dbachecks</a>
<a href=/categories/powershell/>powershell</a>
<a href=/categories/t-sql-tuesday/>t-sql-tuesday</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/t-sql-tuesday-#130-automate-your-stress-away/>T-SQL Tuesday #130 â€“ Automate Your Stress Away</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 09, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p><a class=link href=https://sqlzelda.wordpress.com/2020/09/01/t-sql-tuesday-130-automate-your-stress-away/ target=_blank rel=noopener><img src=/images/tsqltues.png loading=lazy alt="T-SQL Tuesday Logo"></a></p><p>Thanks to Elizabeth Nobel (<a class=link href=https://sqlzelda.wordpress.com/ target=_blank rel=noopener>b</a>|<a class=link href=https://twitter.com/SQLZelda target=_blank rel=noopener>t</a>) for hosting this monthâ€™s T-SQL Tuesday party and apologies for being as late as possible to the party! I love the topic of automation so felt sure Iâ€™d write something and then time slipped away. Luckily Mikey Bronowski (<a class=link href=https://www.bronowski.it/blog/ target=_blank rel=noopener>b</a>|<a class=link href=https://twitter.com/MikeyBronowski target=_blank rel=noopener>t</a>) convinced me that it wasnâ€™t too late to write something on my lunch break today (Wednesday in the UK) as itâ€™s still Tuesday on Baker Island. Interesting fact Baker Island uses UTC-12:00 because since itâ€™s uninhabited the islands time zone is unspecified (<a class=link href=https://en.wikipedia.org/wiki/Baker_Island target=_blank rel=noopener>Wikipedia</a>).</p><h2 id=automating-dbachecks-with-scheduled-task>Automating dbachecks with scheduled task</h2><p>I wanted to write about automating your daily checks with dbachecks, there are many ways of expanding on this post, but this should give you a good basis to build from.</p><h3 id=the-environment>The environment</h3><p>I have two docker containers running on my laptop, one running SQL Server 2017 and one running SQL Server 2019. I will use these SQL Server instances to run my sample daily checks against.</p><p>I have also created a database on the 2019 instance (mssql2) called dbachecks to store our daily check results.</p><h3 id=the-checks>The checks</h3><p>There are hundreds of checks available within the dbachecks module, and on top of that you can even <a class=link href=https://nocolumnname.blog/2018/02/22/adding-your-own-checks-to-dbachecks/ target=_blank rel=noopener>write your own</a> and include those. For this example Iâ€™m going to use the â€˜DatabaseStatusâ€™ check to ensure all my databases are online as expected.</p><h3 id=the-automation>The automation</h3><p>To automate the running of our daily checks weâ€™ll first create a PowerShell script and then schedule that using task scheduler.Â  If you have other enterprise scheduling tools available you could easily use those instead to invoke the PowerShell script.</p><p>The script for my example, shown below, is pretty simple. I have a section to define where the data will be stored (the ability to save dbachecks result information straight into a database was introduced with dbachecks 2.0 and so I would highly recommend updating if youâ€™re on an earlier version).</p><p>The next section (lines 7-9) lists my SQL instances that I want to check, and the checks that should be run.Â  The list of SQL instances could easily be pulled from a text file, a central management server (CMS) or a database to enhance the script.</p><p>The final three lines (lines 11-13) run the checks, apply a label of â€˜MorningChecksâ€™ (this allows for grouping of test results in the reports) and then inserts the results into the database.</p><p>Import-Module dbachecks, dbatools</p><h2 id=dbachecks-database-connection>Dbachecks Database Connection</h2><p>$dbachecksServer = &lsquo;mssql2&rsquo;
$dbachecksDatabase = &lsquo;dbachecks&rsquo;</p><h2 id=define-instances-and-checks-to-run>Define instances and checks to run</h2><p>$SqlInstance = &lsquo;mssql1&rsquo;,&lsquo;mssql2&rsquo;
$checks = &lsquo;DatabaseStatus&rsquo;</p><p>Invoke-DbcCheck -SqlInstance $SqlInstance -Checks $checks -PassThru |
Convert-DbcResult -Label &lsquo;MorningChecks&rsquo; |
Write-DbcTable -SqlInstance $dbachecksServer -Database $dbachecksDatabase</p><p>I saved this script to <code>C:\dbachecks\dbachecks.ps1</code> and then ran the following PowerShell to schedule the execution of the script daily at 7am.</p><p>$RunAs = Get-Credential
$taskSplat = @{
TaskName = &lsquo;Daily dbachecks&rsquo;
Action = (New-ScheduledTaskAction -Execute &lsquo;powershell&rsquo; -Argument &lsquo;-File dbachecks.ps1&rsquo; -WorkingDirectory C:\dbachecks)
Trigger = (New-ScheduledTaskTrigger -Daily -At &lsquo;07:00&rsquo;)
User = $RunAs.UserName
Password = ($RunAs.GetNetworkCredential().Password)
RunLevel = &lsquo;Highest&rsquo;
}
Register-ScheduledTask @taskSplat</p><p>Itâ€™s important to note that the account used to run this scheduled task needs to be an account that has access to all of the SQL instances you want to check, as well as the SQL instance you are writing the final data to.</p><h3 id=results>Results</h3><p>Since this is now scheduled daily we can grab our morning coffee, sit down at our desk and immediately review our estate and ensure everything is as expected.</p><p>We wrote the data to a SQL Server so you can go and query the data directly. By default there will be two tables created in the database.</p><ul><li>CheckResults â€“ contains the actual results of the checks against your server</li><li>dbachecksChecks â€“ contains the metadata of the checks including tags and descriptions for each check you have invoked.</li></ul><p>The other option is to use the dbachecks PowerBi dashboard, by running the following you can load the dashboard and connect to your dbachecks results database:</p><p>Start-DbcPowerBi -FromDatabase</p><p>When this opens you can see there were some failures on mssql1, right clicking on the orange bar you can drill through to see the details.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2020/09/dashboard-1.jpg target=_blank rel=noopener><img src=/images/dashboard-1-1024x583.jpg loading=lazy alt="dbachecks main dashboard"></a></p><p>On the details pane you can see there are two offline databases that I need to look into.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2020/09/drillthrough.jpg target=_blank rel=noopener><img src=/images/drillthrough-1024x279.jpg loading=lazy alt="details view of dbachecks PowerBi"></a></p><h3 id=summary>Summary</h3><p>Finally, this automation is just the starting piece of automating your daily checks. There are many ways to expand on this, but this is how you can get started with automating daily health checks with dbachecks.</p><p>Thanks again for hosting, and sorry for being so late!</p></section><footer class=article-footer><section class=article-tags><a href=/tags/dbachecks/>dbachecks</a>
<a href=/tags/tsql2sday/>tsql2sday</a>
<a href=/tags/tsqltuesday/>tsqltuesday</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/t-sql-tuesday-#135-the-outstanding-tools-of-the-trade-that-make-your-job-awesome/><div class=article-details><h2 class=article-title>T-SQL Tuesday #135: The outstanding tools of the trade that make your job awesome</h2></div></a></article><article><a href=/dbachecks-and-azure-sql-databases/><div class=article-details><h2 class=article-title>dbachecks and Azure SQL Databases</h2></div></a></article><article><a href=/t-sql-tuesday-#108-non-sql-server-technologies/><div class=article-details><h2 class=article-title>T-SQL Tuesday #108 - Non SQL Server Technologies</h2></div></a></article><article><a href=/checking-backups-with-dbachecks/><div class=article-details><h2 class=article-title>Checking backups with dbachecks</h2></div></a></article><article><a href=/t-sql-tuesday-#143-short-code-examples/><div class=article-details><h2 class=article-title>T-SQL Tuesday #143: Short code examples</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>