<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Have you ever wanted to quickly backup/restore a database to the same instance to do some side by side testing? Perhaps to make some index changes or code changes, without actually changing the live copy of the database?Â Ideally youâ€™d already have another environment for this sort of work, but even then sometimes itâ€™s handy to have a quick option.
Letâ€™s first take a look at the databases on my SQL Server- we can use a GUI tool for that (SSMS, ADS) or we can use dbatools."><title>Easily Create A Copy Of Your Database For Testing</title><link rel=canonical href=https://jpomfret.github.io/easily-create-a-copy-of-your-database-for-testing/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Easily Create A Copy Of Your Database For Testing"><meta property="og:description" content="Have you ever wanted to quickly backup/restore a database to the same instance to do some side by side testing? Perhaps to make some index changes or code changes, without actually changing the live copy of the database?Â Ideally youâ€™d already have another environment for this sort of work, but even then sometimes itâ€™s handy to have a quick option.
Letâ€™s first take a look at the databases on my SQL Server- we can use a GUI tool for that (SSMS, ADS) or we can use dbatools."><meta property="og:url" content="https://jpomfret.github.io/easily-create-a-copy-of-your-database-for-testing/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="copy-dbadatabase"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="powershell"><meta property="article:published_time" content="2021-01-19T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-19T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Easily Create A Copy Of Your Database For Testing"><meta name=twitter:description content="Have you ever wanted to quickly backup/restore a database to the same instance to do some side by side testing? Perhaps to make some index changes or code changes, without actually changing the live copy of the database?Â Ideally youâ€™d already have another environment for this sort of work, but even then sometimes itâ€™s handy to have a quick option.
Letâ€™s first take a look at the databases on my SQL Server- we can use a GUI tool for that (SSMS, ADS) or we can use dbatools."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#using-copy-dbadatabase><strong>Using Copy-DbaDatabase</strong></a></li><li><a href=#additional-content><strong>Additional content</strong></a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/dbatools/>dbatools</a>
<a href=/categories/powershell/>powershell</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/easily-create-a-copy-of-your-database-for-testing/>Easily Create A Copy Of Your Database For Testing</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 19, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>Have you ever wanted to quickly backup/restore a database to the same instance to do some side by side testing? Perhaps to make some index changes or code changes, without actually changing the live copy of the database?Â  Ideally youâ€™d already have another environment for this sort of work, but even then sometimes itâ€™s handy to have a quick option.</p><p>Letâ€™s first take a look at the databases on my SQL Server- we can use a GUI tool for that (SSMS, ADS) or we can use dbatools.</p><p>Get-DbaDatabase -SqlInstance mssql1 | Select-Object SqlInstance, Name, Status, Size</p><p><img src=/images/GetDatabase.jpg loading=lazy alt=Get-DbaDatabase></p><p>Weâ€™re working hard on the AdventureWorks2017 database, perhaps getting it ready for an upgrade â€“ since itâ€™s now 3+ years out of date.</p><p>dbatools has so many functions, and I know Iâ€™ve mentioned it before, but <code>Find-DbaCommand</code> is a great way of looking for what we need. I want to know what the default backup path is set to, and since Iâ€™m just backing up and restoring to the same server, we already know that the instance has the required permissions here. If only there was an easy button for thisâ€¦</p><p>Find-DbaCommand *default*path*backup*</p><p><img src=/images/findcommand.jpg loading=lazy alt="results of Find-DbaCommand"></p><p>Even just reading the synopsis, I can see that <code>Get-DbaDefaultPath</code> will give me exactly what I need.Â  I recommend the next step is running <code>Get-Help Get-DbaDefaultPath -ShowWindow</code>, thatâ€™ll create a popup that provides all the information you need about the function.</p><p>The only required parameter is a SqlInstance, and you can see the backup property returns gives us the path we need for our copy.</p><p>Get-DbaDefaultPath -SqlInstance mssql1</p><p><img src=/images/GetDbaDefaultPath.jpg loading=lazy alt="Get-DbaDefaultPath output"></p><p>Thatâ€™s all the groundwork done- we have our instance, database, and a location to backup/restore from.Â  Weâ€™re going to want to check we have enough disk space available on both the instance and that backup path, then weâ€™re ready to go.</p><h2 id=using-copy-dbadatabase><strong>Using Copy-DbaDatabase</strong></h2><p>Iâ€™ve already spoken and blogged a lot about the power of this command (related links at the end of this post), but todayâ€™s tip is centred around a less than well-known parameter.Â  Hidden deep in the comment based help (another great reason to read all of <code>Get-Help Copy-DbaDatabase -ShowWindow</code>) youâ€™ll find the â€˜Prefixâ€™ parameter. This will allow us to easily add a prefix to both the database and the associated files, meaning we wonâ€™t have any issues restoring the database to the same server.</p><p>-Prefix<br>All copied database names and physical files will be prefixed with this string</p><p>This option is mutually exclusive of NewName</p><p>Required? false
Position? named
Default value<br>Accept pipeline input? False
Accept wildcard characters? false</p><p>Here Iâ€™ve set a SqlInstance variable so I can reuse the same value multiple times in my code. Then created a hash table â€˜$copySplatâ€™ with the necessary parameters so we can utilise splatting (a way to improve code readability) to pass the whole set into <code>Copy-DbaDatabase</code>.Â </p><p>Two parameters I want to highlight- Iâ€™ve set â€˜Prefixâ€™, meaning the database and files for the restored database will start with â€˜Testâ€™.Â  Iâ€™ve also set SharedPath and used the code we already wrote to get the default backup path.</p><p>$sqlInstance = &lsquo;mssql1&rsquo;</p><p>$copySplat = @{
Source = $sqlInstance
Destination = $sqlInstance
Database = &lsquo;AdventureWorks2017&rsquo;
BackupRestore = $true
SharedPath = (Get-DbaDefaultPath -SqlInstance $sqlInstance).Backup
Prefix = &lsquo;Test&rsquo;
}
Copy-DbaDatabase @copySplat</p><p><img src=/images/copyDatabase.jpg loading=lazy alt=Copy-DbaDatabase></p><p>The output below shows the migration was successful, and there were no warnings or errors (those would appear in the notes column).</p><p>Finally, letâ€™s confirm it worked by rerunning our <code>Get-DbaDatabase</code> command again:</p><p><img src=/images/GetDatabaseAfter.jpg loading=lazy></p><p>Extra proof, itâ€™s now accessible through Azure Data Studio (ADS) and weâ€™re ready to start our testing.Â  One note, if you are on the same server itâ€™s important to confirm any code you run isnâ€™t referencing the original database name.</p><p><img src=/images/ADSView.jpg loading=lazy></p><h2 id=additional-content><strong>Additional content</strong></h2><p>As I mentioned I have already spoken and written about the power of <code>Copy-DbaDatabase</code>, one of my favourite commands.Â  If youâ€™d like to read more, Iâ€™ve written a post on the dbatools blog, <a class=link href=https://dbatools.io/migrating-application-dbs/ target=_blank rel=noopener>migrating application databases with dbatools</a>.</p><p>Iâ€™ve also recorded a short â€˜Life hackâ€™ video, <a class=link href="https://www.youtube.com/watch?v=Fraig15pwxE&t=1s" target=_blank rel=noopener>easy database migrations with dbatools</a> that Iâ€™ve published on my YouTube channel.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/copy-dbadatabase/>copy-dbadatabase</a>
<a href=/tags/dbatools/>dbatools</a>
<a href=/tags/powershell/>powershell</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/log-ship-staged/><div class=article-image><img src=/log-ship-staged/cover.f4ab6d164035c79e896561924d558d00_hufa84d3a6e624ae2b3ca125fbcc0da73a_679878_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Log Shipping â€“ Pre-stage database backups with dbatools" data-key=log-ship-staged data-hash="md5-9KttFkA1x56JZWGSTVWNAA=="></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article><article><a href=/collating-index-usage-stats-across-availability-group-replicas/><div class=article-details><h2 class=article-title>Collating index usage stats across Availability Group replicas</h2></div></a></article><article><a href=/searching-stored-procedures-for-a-pattern-made-easy-with-dbatools/><div class=article-details><h2 class=article-title>Searching Stored Procedures for a pattern made easy with dbatools</h2></div></a></article><article><a href=/quickly-execute-a-folder-of-sql-scripts-against-a-sql-server/><div class=article-details><h2 class=article-title>Quickly Execute a Folder of SQL Scripts against a SQL Server</h2></div></a></article><article><a href=/troubleshooting-spn-troubles-cannot-generate-sspi-context/><div class=article-details><h2 class=article-title>Troubleshooting SPN Troubles - Cannot generate SSPI context</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>