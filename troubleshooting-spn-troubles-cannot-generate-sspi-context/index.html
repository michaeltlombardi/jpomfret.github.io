<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I was working in my lab environment this weekend, playing with some SQL Servers that I had built with PowerShell DSC a while ago.Â I had installed SQL Server with mostly defaults, including not changing the engine and agent service accounts.Â For the blog post I thought I was going to write next, I wanted to change these to be active directory accounts â€“ it did not go smoothly, and I figured this might be useful to document for future Jess, or anyone else who might stumble across this problem."><title>Troubleshooting SPN Troubles - Cannot generate SSPI context</title><link rel=canonical href=https://jpomfret.github.io/troubleshooting-spn-troubles-cannot-generate-sspi-context/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Troubleshooting SPN Troubles - Cannot generate SSPI context"><meta property="og:description" content="I was working in my lab environment this weekend, playing with some SQL Servers that I had built with PowerShell DSC a while ago.Â I had installed SQL Server with mostly defaults, including not changing the engine and agent service accounts.Â For the blog post I thought I was going to write next, I wanted to change these to be active directory accounts â€“ it did not go smoothly, and I figured this might be useful to document for future Jess, or anyone else who might stumble across this problem."><meta property="og:url" content="https://jpomfret.github.io/troubleshooting-spn-troubles-cannot-generate-sspi-context/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="kerberos"><meta property="article:tag" content="powershell"><meta property="article:tag" content="spn"><meta property="article:published_time" content="2021-02-16T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-16T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Troubleshooting SPN Troubles - Cannot generate SSPI context"><meta name=twitter:description content="I was working in my lab environment this weekend, playing with some SQL Servers that I had built with PowerShell DSC a while ago.Â I had installed SQL Server with mostly defaults, including not changing the engine and agent service accounts.Â For the blog post I thought I was going to write next, I wanted to change these to be active directory accounts â€“ it did not go smoothly, and I figured this might be useful to document for future Jess, or anyone else who might stumble across this problem."><script async src="https://www.googletagmanager.com/gtag/js?id=G-YL15E7BXXF"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YL15E7BXXF",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#create-the-issue-change-sql-server-service-accounts>Create the Issue: Change SQL Server Service Accounts</a></li><li><a href=#the-issue>The Issue</a></li><li><a href=#lets-fix-it>Let&rsquo;s Fix It</a></li><li><a href=#summary>Summary</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/dbatools/>dbatools</a>
<a href=/categories/powershell/>powershell</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/troubleshooting-spn-troubles-cannot-generate-sspi-context/>Troubleshooting SPN Troubles - Cannot generate SSPI context</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Feb 16, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p>I was working in my lab environment this weekend, playing with some SQL Servers that I had built with PowerShell DSC a while ago.Â  I had installed SQL Server with mostly defaults, including not changing the engine and agent service accounts.Â  For the blog post I thought I was going to write next, I wanted to change these to be active directory accounts â€“ it did not go smoothly, and I figured this might be useful to document for future Jess, or anyone else who might stumble across this problem.</p><h2 id=create-the-issue-change-sql-server-service-accounts>Create the Issue: Change SQL Server Service Accounts</h2><p>First off, I created two new Active Directory users that Iâ€™ll use for my service accounts. The below code will create a prompt for each account for the password to be entered.</p><p>$engSvcAccount = &lsquo;svc-dscsvr1-eng2&rsquo;
$agSvcAccount = &lsquo;svc-dscsvr1-ag2&rsquo;</p><p>$EngSvcAccount = @{
Name = $engSvcAccount
UserPrincipalName = $engSvcAccount
AccountPassword = (Get-Credential -Credential EnterPassword).Password
PasswordNeverExpires = $true
Enabled = $true
}
New-AdUser @EngSvcAccount</p><p>$AgentSvcAccount = @{
Name = $agSvcAccount
UserPrincipalName = $agSvcAccount
AccountPassword = (Get-Credential -Credential EnterPassword).Password
PasswordNeverExpires = $true
Enabled = $true
}
New-AdUser @AgentSvcAccount</p><p>We can view the current SQL services with <code>Get-DbaService</code>. This is useful to see what account they are currently running under, as well as the service names.</p><p>Get-DbaService -ComputerName dscsvr1 | Format-Table</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/02/GetDbaService.jpg target=_blank rel=noopener><img src=/images/GetDbaService.jpg loading=lazy></a></p><p>There is also a command for updating service accounts in dbatools. I will note, sometimes I have issues with the command being able to update the accounts and Iâ€™m not sure why. It worked perfectly in this scenario though running the following.</p><p>This again creates a prompt to enter the service account password, before setting the service &lsquo;StartName&rsquo;.</p><p>Update-DbaServiceAccount -ComputerName dscsvr1 -ServiceName MSSQLSERVER -ServiceCredential (Get-Credential -Credential &ldquo;Pomfret\$engSvcAccount&rdquo; )
Update-DbaServiceAccount -ComputerName dscsvr1 -ServiceName SQLSERVERAGENT -ServiceCredential (Get-Credential -Credential &ldquo;Pomfret\$agSvcAccount&rdquo; )</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/02/UpdateDbaServiceAccount.png target=_blank rel=noopener><img src=/images/UpdateDbaServiceAccount.png loading=lazy></a></p><p>If I rerun <code>Get-DbaService</code> I can see all looks good. <code>StartName</code> shows my new accounts and the services for both engine and agent are running.</p><p>Get-DbaService -ComputerName dscsvr1 | Format-Table</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/02/GetDbaService_post.jpg target=_blank rel=noopener><img src=/images/GetDbaService_post.jpg loading=lazy></a></p><h2 id=the-issue>The Issue</h2><p>At this point I was still planning on writing a blog post on a totally different topic. I ran the following to determine what databases I already had on dscsvr1:</p><p>Get-DbaDatabase -SqlInstance dscsvr1 -ExcludeSystem | Format-Table</p><p>But instead of getting a quick answer to my question, I just got the following error:</p><p><em>WARNING: [15:19:49][Get-DbaDatabase] Error occurred while establishing connection to dscsvr1 | The target principal name is incorrect. Cannot generate SSPI context.</em></p><p>I checked a few things as I started troubleshooting:</p><ul><li>Are the services running â€“ we already checked this with <code>Get-DbaService</code> and they are</li><li>Was it firewall related â€“ inbound rules were in place, and I was able to previously connect</li><li>Was it certificate related â€“ Iâ€™m not forcing encryption, and there are no certificates set up</li><li>Was it Service Principal Name (SPN) related â€“ bingo</li></ul><p>I have seen this happen before when changing service accounts for SQL services. Iâ€™m not an Active Directory expert, and Iâ€™m certainly not a Kerberos expert â€“ in fact Iâ€™m as surprised as you that Kerberos has actually appeared on this blog.Â </p><p>What I do know is that due to permissions, the SPNs needed were not able to be registered for the new service accounts.Â  The easiest way to investigate SPN issues is with dbatools, saving us again!</p><p><code>Test-DbaSpn</code> works out exactly what SPNs are needed for our SQL instances and determines if they are in place.</p><p>Test-DbaSpn -ComputerName dscsvr1 | Format-Table</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/02/Test-DbaSpn.jpg target=_blank rel=noopener><img src=/images/Test-DbaSpn.jpg loading=lazy></a></p><p>This shows we should have two SPNs set for the default instance (MSSQLSERVER) on DscSvr1.Â  The â€˜IsSetâ€™ column shows they arenâ€™t set â€“ and this is why we canâ€™t connect to our instance remotely.</p><h2 id=lets-fix-it>Let&rsquo;s Fix It</h2><p>The fix for this issue seems simple- register the required SPNs.Â  dbatools again tries to make this as easy as possible for us. We can take the output from <code>Test-DbaSpn</code> and pipe it straight into <code>Set-DbaSpn</code> and dbatools will take care of the rest â€“ wonâ€™t it?</p><p>Test-DbaSpn -ComputerName dscsvr1 | Set-DbaSpn</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/02/FailedToSetSPN.jpg target=_blank rel=noopener><img src=/images/FailedToSetSPN.jpg loading=lazy></a></p><p>As you can see from the warning message, dbatools wasnâ€™t able to set our required SPNs either. It complains about &lsquo;A constraint violation occurred&rsquo;.</p><p>The reason is each SPN can only be registered once, and these SPNs were created for the previous service accounts and never cleaned up due to a lack of permissions.</p><p>We now need to use the <code>setspn</code> command line tool that is built into Windows and available when you have AD windows features installed, but the output from the dbatools command is still very useful for building the inputs for <code>setspn</code>.</p><p>First weâ€™ll try and register the required SPNs manually. For this weâ€™ll use the -a parameter on <code>setspn</code>, the format being:</p><p>setspn -a &#171;SPN&#187; &#171;ServiceAccount&#187;</p><p>So weâ€™ll run the following, getting the SPN from the â€˜RequiredSPNâ€™ column of the <code>Test-DbaSpn</code> output. Youâ€™ll notice there are two required SPNs, one without a port specified and one with 1433 â€“ weâ€™ll want to fix both.</p><p>setspn -a MSSQLSvc/DscSvr1.pomfret.com Pomfret\svc-dscsvr1-eng2</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/02/duplicateSpn.jpg target=_blank rel=noopener><img src=/images/duplicateSpn.jpg loading=lazy></a></p><p>You can see in the output, the problem is highlighted â€“ â€˜Duplicate SPN foundâ€™.Â  The useful part of this output is on the second line.Â  Iâ€™ve highlighted the current owner of the SPN â€“ we need this to be able to resolve the problem.Â  Not surprising, it is the computer account since I was previously running SQL Server as the default <code>NT SERVICE\MSSQLSERVER</code> account.</p><p>Now we know what the duplicate is we can remove it, again using setspn, but this time with the -d parameter. The format is:</p><p>setspn -d &#171;SPN&#187; &#171;ServiceAccount&#187;</p><p>Weâ€™ll run the following two commands to clear up both old SPNs:</p><p>setspn -d MSSQLSvc/DscSvr1.pomfret.com DSCSVR1
setspn -d MSSQLSvc/DscSvr1.pomfret.com:1433 DSCSVR1</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/02/DeleteSPN.jpg target=_blank rel=noopener><img src=/images/DeleteSPN.jpg loading=lazy></a></p><p>Finally we can add the required SPNs. We can either use dbatools with the code we tried earlier or <code>setspn</code>.</p><p>setspn -a MSSQLSvc/DscSvr1.pomfret.com Pomfret\svc-dscsvr1-eng2
setspn -a MSSQLSvc/DscSvr1.pomfret.com:1433 Pomfret\svc-dscsvr1-eng2</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/02/addSpn.jpg target=_blank rel=noopener><img src=/images/addSpn.jpg loading=lazy></a></p><p>You can see the output now states â€˜Updated objectâ€™ which means we were successful. If we try and view the databases again now we should see the output we were expecting.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/02/Get-DbaDatabase.jpg target=_blank rel=noopener><img src=/images/Get-DbaDatabase.jpg loading=lazy></a></p><h2 id=summary>Summary</h2><p>As I mentioned, this was not at all what I was expecting to write about â€“ but I hope itâ€™ll be useful if you ever find yourself in this situation while trying to change service accounts for SQL Server.</p><p>I was in the end able to resolve the permissions problems for my service accounts by following this great blog post &lsquo;<a class=link href=http://www.alexandreviot.net/2014/09/30/sql-server-could-not-register-the-service-principal-name-spn/ target=_blank rel=noopener>SQL Server - Could not register the Service Principal Name</a>&rsquo;. Once I applied these permissions when I changed service accounts they were able to delete and recreate the required SPNs.</p><p>Another great blog post for more reading on SPNs is this post by <a class=link href=https://www.twitter.com/pittfurg target=_blank rel=noopener>Drew Furgiuele</a> on how to use the <a class=link href=https://dbatools.io/schwifty/ target=_blank rel=noopener>dbatools SPN commands</a>.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/dbatools/>dbatools</a>
<a href=/tags/kerberos/>kerberos</a>
<a href=/tags/powershell/>powershell</a>
<a href=/tags/spn/>spn</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/log-ship-staged/><div class=article-image><img src=/log-ship-staged/cover.f4ab6d164035c79e896561924d558d00_hufa84d3a6e624ae2b3ca125fbcc0da73a_679878_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Log Shipping â€“ Pre-stage database backups with dbatools" data-key=log-ship-staged data-hash="md5-9KttFkA1x56JZWGSTVWNAA=="></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article><article><a href=/collating-index-usage-stats-across-availability-group-replicas/><div class=article-details><h2 class=article-title>Collating index usage stats across Availability Group replicas</h2></div></a></article><article><a href=/searching-stored-procedures-for-a-pattern-made-easy-with-dbatools/><div class=article-details><h2 class=article-title>Searching Stored Procedures for a pattern made easy with dbatools</h2></div></a></article><article><a href=/quickly-execute-a-folder-of-sql-scripts-against-a-sql-server/><div class=article-details><h2 class=article-title>Quickly Execute a Folder of SQL Scripts against a SQL Server</h2></div></a></article><article><a href=/discover-sql-server-permissions-hidden-via-ad-group-membership/><div class=article-details><h2 class=article-title>Discover SQL Server Permissions hidden via AD Group Membership</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>