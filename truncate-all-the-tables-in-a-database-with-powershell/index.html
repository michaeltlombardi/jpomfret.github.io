<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="TLDR; This code will script out foreign keys and views (including object level permissions), drop the objects, truncate all the tables, and recreate the objects.
The Details The most popular post on my blog so far was called â€˜Disable all Triggers on a Databaseâ€™ and this one is a good follow up from that post.
The scenario here is you need to remove all the data from the tables in your database."><title>Truncate all the Tables in a Database with PowerShell</title><link rel=canonical href=https://jpomfret.github.io/truncate-all-the-tables-in-a-database-with-powershell/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Truncate all the Tables in a Database with PowerShell"><meta property="og:description" content="TLDR; This code will script out foreign keys and views (including object level permissions), drop the objects, truncate all the tables, and recreate the objects.
The Details The most popular post on my blog so far was called â€˜Disable all Triggers on a Databaseâ€™ and this one is a good follow up from that post.
The scenario here is you need to remove all the data from the tables in your database."><meta property="og:url" content="https://jpomfret.github.io/truncate-all-the-tables-in-a-database-with-powershell/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="truncate"><meta property="article:published_time" content="2020-06-30T00:00:00+00:00"><meta property="article:modified_time" content="2020-06-30T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Truncate all the Tables in a Database with PowerShell"><meta name=twitter:description content="TLDR; This code will script out foreign keys and views (including object level permissions), drop the objects, truncate all the tables, and recreate the objects.
The Details The most popular post on my blog so far was called â€˜Disable all Triggers on a Databaseâ€™ and this one is a good follow up from that post.
The scenario here is you need to remove all the data from the tables in your database."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#the-details>The Details</a></li><li><a href=#truncate-tables-with-powershell>Truncate tables with PowerShell</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/dbatools/>dbatools</a>
<a href=/categories/powershell/>powershell</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/truncate-all-the-tables-in-a-database-with-powershell/>Truncate all the Tables in a Database with PowerShell</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jun 30, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p><strong>TLDR</strong>; <a class=link href=https://github.com/jpomfret/demos/blob/master/BlogExamples/05_TruncateAllTables.ps1 target=_blank rel=noopener>This code</a> will script out foreign keys and views (including object level permissions), drop the objects, truncate all the tables, and recreate the objects.</p><h2 id=the-details>The Details</h2><p>The most popular post on my blog so far was called â€˜<a class=link href=https://jesspomfret.com/disable-all-triggers/ target=_blank rel=noopener>Disable all Triggers on a Database</a>â€™ and this one is a good follow up from that post.</p><p>The scenario here is you need to remove all the data from the tables in your database. This could be as part of a refresh process, or perhaps to clear out test data that has been entered through an application.Â  Either way, you want to truncate all the tables in your database.</p><p>Using a copy of the AdventureWorks2017 database for my demos, the easiest option to truncate all the tables is to script out truncate statements using the metadata stored in <code>sys.tables</code>.</p><p>SELECT &lsquo;Truncate table &rsquo; + QUOTENAME(SCHEMA_NAME(schema_id)) + &lsquo;.&rsquo; + QUOTENAME(name)
FROM sys.tables</p><p>Youâ€™ll get a results set like shown below which you can copy out into a new query window and execute.</p><p><img src=/images/TruncateFromSysTables.png loading=lazy alt="select from sys.tables to generate truncate statements"></p><p>The problem is if you have foreign keys, even if you order the truncate statements to remove the dependent data first, you canâ€™t issue a truncate statement. The way around this is to script out the foreign keys, drop them, run the truncate statements and then recreate the foreign keys. This is not difficult in T-SQL, but itâ€™s easier with PowerShell and a little bit of <a class=link href=https://dbatools.io/ target=_blank rel=noopener>dbatools</a> magic.</p><h2 id=truncate-tables-with-powershell>Truncate tables with PowerShell</h2><p>The full script is available up on my <a class=link href=https://github.com/jpomfret/demos/blob/master/BlogExamples/05_TruncateAllTables.ps1 target=_blank rel=noopener>Github</a>, but Iâ€™ll walk through the process here. During my post on disabling triggers I stored the previously enabled triggers in a variable to reuse during the script.Â  I had a really great comment on this post that pointed out a problem: if the session crashed for some reason we would lose the list of triggers we wanted to enable. I will solve that problem in this post by instead of using a variable, saving the information in a temporary file.</p><p>First things first, we need to set up a couple of variables to define our SqlInstance, database and the folder weâ€™ll use as our workspace.</p><p>Iâ€™ll then use <code>Connect-DbaInstance</code> to connect to the instance and save the smo object. This will save having to reconnect to the instance multiple times.</p><p>$sqlInstance = &lsquo;mssql1&rsquo;
$database = &lsquo;AdventureWorks2017&rsquo;
$tempFolder = &lsquo;C:\temp&rsquo;</p><p>$svr = Connect-DbaInstance -SqlInstance $sqlInstance</p><p>The next step is to collect the foreign keys that weâ€™ll need to drop and recreate. Itâ€™s important to note here there are also some views that depend on these tables, so I can also collect that information at the same time.Â </p><p># Collect up the objects we need to drop and recreate
$objects = @()
$objects += Get-DbaDbForeignKey -SqlInstance $svr -Database $database
$objects += Get-DbaDbView -SqlInstance $svr -Database $database -ExcludeSystemView</p><p>Now that we have collected the objects into a variable we can pipe this to the <code>Export-DbaScript</code> command to generate T-SQL scripts for both dropping and then recreating the objects. Something to take into consideration when dropping and recreating views is that if there are permissions set at the object level we need to include those in our create scripts.Â  We can use the <code>New-DbaScriptingOption</code> command to set the options we care about when we create the scripts.</p><p>Here we are including the permissions, the â€˜ScriptBatchTerminatorâ€™, which will add â€˜Goâ€™ between objects, and finally setting the file type to ANSI. Â When we call <code>Export-DbaScript</code> we can then use these options for the <code>-ScriptingOptionsObject</code> parameter.</p><p># Script out the create statements for objects
$createOptions = New-DbaScriptingOption
$createOptions.Permissions = $true
$createOptions.ScriptBatchTerminator = $true
$createOptions.AnsiFile = $true</p><p>$objects | Export-DbaScript -FilePath (&rsquo;{0}\CreateObjects.Sql&rsquo; -f $tempFolder) -ScriptingOptionsObject $createOptions</p><p>We also need to script out the drop statements. To do that weâ€™ll create another options object, this time setting <code>ScriptDrops</code> to true. Then weâ€™ll again call <code>Export-DbaScript</code> with the <code>-ScriptingOptionsObject</code> parameter.</p><p># Script out the drop statements for objects
$options = New-DbaScriptingOption
$options.ScriptDrops = $true
$objects| Export-DbaScript -FilePath (&rsquo;{0}\DropObjects.Sql&rsquo; -f $tempFolder) -ScriptingOptionsObject $options</p><p>Once we have the scripts safely in our temporary folder weâ€™ll run three simple statements.</p><p>First, weâ€™ll run the drop statements we scripted out.</p><p>Second, remember we saved the smo connection to our server in the <code>$svr</code> variable. Weâ€™ll use that to access all the tables in our database, pipe that to a <code>Foreach-Object</code> and call the <code>TruncateData</code> method.</p><p>Third, weâ€™ll call <code>Invoke-DbaQuery</code> to recreate the foreign keys and the views we previously dropped.</p><p># Run the drop scripts
Invoke-DbaQuery -SqlInstance $svr -Database $database -File (&rsquo;{0}\DropObjects.Sql&rsquo; -f $tempFolder)</p><h1 id=truncate-the-tables>Truncate the tables</h1><p>$svr.databases[$database].Tables | ForEach-Object { $_.TruncateData() }</p><h1 id=run-the-create-scripts>Run the create scripts</h1><p>Invoke-DbaQuery -SqlInstance $svr -Database $database -File (&rsquo;{0}\CreateObjects.Sql&rsquo; -f $tempFolder)</p><p>The final step is to clear up the script files we saved to the temporary folder.</p><p># Clear up the script files
Remove-Item (&rsquo;{0}\DropObjects.Sql&rsquo; -f $tempFolder), (&rsquo;{0}\CreateObjects.Sql&rsquo; -f $tempFolder)</p><p>This script can be reused for any database that you may need to clear out. As I was writing this post, I realised this could probably be a dbatools commandâ€¦ watch this space. ?</p></section><footer class=article-footer><section class=article-tags><a href=/tags/dbatools/>dbatools</a>
<a href=/tags/truncate/>truncate</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/log-ship-staged/><div class=article-image><img src=/log-ship-staged/cover.f4ab6d164035c79e896561924d558d00_hufa84d3a6e624ae2b3ca125fbcc0da73a_679878_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Log Shipping â€“ Pre-stage database backups with dbatools" data-key=log-ship-staged data-hash="md5-9KttFkA1x56JZWGSTVWNAA=="></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article><article><a href=/collating-index-usage-stats-across-availability-group-replicas/><div class=article-details><h2 class=article-title>Collating index usage stats across Availability Group replicas</h2></div></a></article><article><a href=/searching-stored-procedures-for-a-pattern-made-easy-with-dbatools/><div class=article-details><h2 class=article-title>Searching Stored Procedures for a pattern made easy with dbatools</h2></div></a></article><article><a href=/quickly-execute-a-folder-of-sql-scripts-against-a-sql-server/><div class=article-details><h2 class=article-title>Quickly Execute a Folder of SQL Scripts against a SQL Server</h2></div></a></article><article><a href=/troubleshooting-spn-troubles-cannot-generate-sspi-context/><div class=article-details><h2 class=article-title>Troubleshooting SPN Troubles - Cannot generate SSPI context</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>