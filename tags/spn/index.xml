<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>spn on Jess Pomfret</title><link>https://jpomfret.github.io/tags/spn/</link><description>Recent content in spn on Jess Pomfret</description><generator>Hugo -- gohugo.io</generator><language>en-gb</language><lastBuildDate>Tue, 16 Feb 2021 00:00:00 +0000</lastBuildDate><atom:link href="https://jpomfret.github.io/tags/spn/index.xml" rel="self" type="application/rss+xml"/><item><title>Troubleshooting SPN Troubles - Cannot generate SSPI context</title><link>https://jpomfret.github.io/p/troubleshooting-spn-troubles-cannot-generate-sspi-context/</link><pubDate>Tue, 16 Feb 2021 00:00:00 +0000</pubDate><guid>https://jpomfret.github.io/p/troubleshooting-spn-troubles-cannot-generate-sspi-context/</guid><description>&lt;p>I was working in my lab environment this weekend, playing with some SQL Servers that I had built with PowerShell DSC a while ago.  I had installed SQL Server with mostly defaults, including not changing the engine and agent service accounts.  For the blog post I thought I was going to write next, I wanted to change these to be active directory accounts – it did not go smoothly, and I figured this might be useful to document for future Jess, or anyone else who might stumble across this problem.&lt;/p>
&lt;h2 id="create-the-issue-change-sql-server-service-accounts">Create the Issue: Change SQL Server Service Accounts&lt;/h2>
&lt;p>First off, I created two new Active Directory users that I’ll use for my service accounts. The below code will create a prompt for each account for the password to be entered.&lt;/p>
&lt;p>$engSvcAccount = &amp;lsquo;svc-dscsvr1-eng2&amp;rsquo;
$agSvcAccount = &amp;lsquo;svc-dscsvr1-ag2&amp;rsquo;&lt;/p>
&lt;p>$EngSvcAccount = @{
Name = $engSvcAccount
UserPrincipalName = $engSvcAccount
AccountPassword = (Get-Credential -Credential EnterPassword).Password
PasswordNeverExpires = $true
Enabled = $true
}
New-AdUser @EngSvcAccount&lt;/p>
&lt;p>$AgentSvcAccount = @{
Name = $agSvcAccount
UserPrincipalName = $agSvcAccount
AccountPassword = (Get-Credential -Credential EnterPassword).Password
PasswordNeverExpires = $true
Enabled = $true
}
New-AdUser @AgentSvcAccount&lt;/p>
&lt;p>We can view the current SQL services with &lt;code>Get-DbaService&lt;/code>. This is useful to see what account they are currently running under, as well as the service names.&lt;/p>
&lt;p>Get-DbaService -ComputerName dscsvr1 | Format-Table&lt;/p>
&lt;p>&lt;a class="link" href="https://jesspomfret.com/wp-content/uploads/2021/02/GetDbaService.jpg" target="_blank" rel="noopener"
>&lt;img src="https://jpomfret.github.io/images/GetDbaService.jpg"
loading="lazy"
>&lt;/a>&lt;/p>
&lt;p>There is also a command for updating service accounts in dbatools. I will note, sometimes I have issues with the command being able to update the accounts and I’m not sure why. It worked perfectly in this scenario though running the following.&lt;/p>
&lt;p>This again creates a prompt to enter the service account password, before setting the service &amp;lsquo;StartName&amp;rsquo;.&lt;/p>
&lt;p>Update-DbaServiceAccount -ComputerName dscsvr1 -ServiceName MSSQLSERVER -ServiceCredential (Get-Credential -Credential &amp;ldquo;Pomfret\$engSvcAccount&amp;rdquo; )
Update-DbaServiceAccount -ComputerName dscsvr1 -ServiceName SQLSERVERAGENT -ServiceCredential (Get-Credential -Credential &amp;ldquo;Pomfret\$agSvcAccount&amp;rdquo; )&lt;/p>
&lt;p>&lt;a class="link" href="https://jesspomfret.com/wp-content/uploads/2021/02/UpdateDbaServiceAccount.png" target="_blank" rel="noopener"
>&lt;img src="https://jpomfret.github.io/images/UpdateDbaServiceAccount.png"
loading="lazy"
>&lt;/a>&lt;/p>
&lt;p>If I rerun &lt;code>Get-DbaService&lt;/code> I can see all looks good. &lt;code>StartName&lt;/code> shows my new accounts and the services for both engine and agent are running.&lt;/p>
&lt;p>Get-DbaService -ComputerName dscsvr1 | Format-Table&lt;/p>
&lt;p>&lt;a class="link" href="https://jesspomfret.com/wp-content/uploads/2021/02/GetDbaService_post.jpg" target="_blank" rel="noopener"
>&lt;img src="https://jpomfret.github.io/images/GetDbaService_post.jpg"
loading="lazy"
>&lt;/a>&lt;/p>
&lt;h2 id="the-issue">The Issue&lt;/h2>
&lt;p>At this point I was still planning on writing a blog post on a totally different topic. I ran the following to determine what databases I already had on dscsvr1:&lt;/p>
&lt;p>Get-DbaDatabase -SqlInstance dscsvr1 -ExcludeSystem | Format-Table&lt;/p>
&lt;p>But instead of getting a quick answer to my question, I just got the following error:&lt;/p>
&lt;p>&lt;em>WARNING: [15:19:49][Get-DbaDatabase] Error occurred while establishing connection to dscsvr1 | The target principal name is incorrect. Cannot generate SSPI context.&lt;/em>&lt;/p>
&lt;p>I checked a few things as I started troubleshooting:&lt;/p>
&lt;ul>
&lt;li>Are the services running – we already checked this with &lt;code>Get-DbaService&lt;/code> and they are&lt;/li>
&lt;li>Was it firewall related – inbound rules were in place, and I was able to previously connect&lt;/li>
&lt;li>Was it certificate related – I’m not forcing encryption, and there are no certificates set up&lt;/li>
&lt;li>Was it Service Principal Name (SPN) related – bingo&lt;/li>
&lt;/ul>
&lt;p>I have seen this happen before when changing service accounts for SQL services. I’m not an Active Directory expert, and I’m certainly not a Kerberos expert – in fact I’m as surprised as you that Kerberos has actually appeared on this blog. &lt;/p>
&lt;p>What I do know is that due to permissions, the SPNs needed were not able to be registered for the new service accounts.  The easiest way to investigate SPN issues is with dbatools, saving us again!&lt;/p>
&lt;p>&lt;code>Test-DbaSpn&lt;/code> works out exactly what SPNs are needed for our SQL instances and determines if they are in place.&lt;/p>
&lt;p>Test-DbaSpn -ComputerName dscsvr1 | Format-Table&lt;/p>
&lt;p>&lt;a class="link" href="https://jesspomfret.com/wp-content/uploads/2021/02/Test-DbaSpn.jpg" target="_blank" rel="noopener"
>&lt;img src="https://jpomfret.github.io/images/Test-DbaSpn.jpg"
loading="lazy"
>&lt;/a>&lt;/p>
&lt;p>This shows we should have two SPNs set for the default instance (MSSQLSERVER) on DscSvr1.  The ‘IsSet’ column shows they aren’t set – and this is why we can’t connect to our instance remotely.&lt;/p>
&lt;h2 id="lets-fix-it">Let&amp;rsquo;s Fix It&lt;/h2>
&lt;p>The fix for this issue seems simple- register the required SPNs.  dbatools again tries to make this as easy as possible for us. We can take the output from &lt;code>Test-DbaSpn&lt;/code> and pipe it straight into &lt;code>Set-DbaSpn&lt;/code> and dbatools will take care of the rest – won’t it?&lt;/p>
&lt;p>Test-DbaSpn -ComputerName dscsvr1 | Set-DbaSpn&lt;/p>
&lt;p>&lt;a class="link" href="https://jesspomfret.com/wp-content/uploads/2021/02/FailedToSetSPN.jpg" target="_blank" rel="noopener"
>&lt;img src="https://jpomfret.github.io/images/FailedToSetSPN.jpg"
loading="lazy"
>&lt;/a>&lt;/p>
&lt;p>As you can see from the warning message, dbatools wasn’t able to set our required SPNs either. It complains about &amp;lsquo;A constraint violation occurred&amp;rsquo;.&lt;/p>
&lt;p>The reason is each SPN can only be registered once, and these SPNs were created for the previous service accounts and never cleaned up due to a lack of permissions.&lt;/p>
&lt;p>We now need to use the &lt;code>setspn&lt;/code> command line tool that is built into Windows and available when you have AD windows features installed, but the output from the dbatools command is still very useful for building the inputs for &lt;code>setspn&lt;/code>.&lt;/p>
&lt;p>First we’ll try and register the required SPNs manually. For this we’ll use the -a parameter on &lt;code>setspn&lt;/code>, the format being:&lt;/p>
&lt;p>setspn -a &amp;laquo;SPN&amp;raquo; &amp;laquo;ServiceAccount&amp;raquo;&lt;/p>
&lt;p>So we’ll run the following, getting the SPN from the ‘RequiredSPN’ column of the &lt;code>Test-DbaSpn&lt;/code> output. You’ll notice there are two required SPNs, one without a port specified and one with 1433 – we’ll want to fix both.&lt;/p>
&lt;p>setspn -a MSSQLSvc/DscSvr1.pomfret.com Pomfret\svc-dscsvr1-eng2&lt;/p>
&lt;p>&lt;a class="link" href="https://jesspomfret.com/wp-content/uploads/2021/02/duplicateSpn.jpg" target="_blank" rel="noopener"
>&lt;img src="https://jpomfret.github.io/images/duplicateSpn.jpg"
loading="lazy"
>&lt;/a>&lt;/p>
&lt;p>You can see in the output, the problem is highlighted – ‘Duplicate SPN found’.  The useful part of this output is on the second line.  I’ve highlighted the current owner of the SPN – we need this to be able to resolve the problem.  Not surprising, it is the computer account since I was previously running SQL Server as the default &lt;code>NT SERVICE\MSSQLSERVER&lt;/code> account.&lt;/p>
&lt;p>Now we know what the duplicate is we can remove it, again using setspn, but this time with the -d parameter. The format is:&lt;/p>
&lt;p>setspn -d &amp;laquo;SPN&amp;raquo; &amp;laquo;ServiceAccount&amp;raquo;&lt;/p>
&lt;p>We’ll run the following two commands to clear up both old SPNs:&lt;/p>
&lt;p>setspn -d MSSQLSvc/DscSvr1.pomfret.com DSCSVR1
setspn -d MSSQLSvc/DscSvr1.pomfret.com:1433 DSCSVR1&lt;/p>
&lt;p>&lt;a class="link" href="https://jesspomfret.com/wp-content/uploads/2021/02/DeleteSPN.jpg" target="_blank" rel="noopener"
>&lt;img src="https://jpomfret.github.io/images/DeleteSPN.jpg"
loading="lazy"
>&lt;/a>&lt;/p>
&lt;p>Finally we can add the required SPNs. We can either use dbatools with the code we tried earlier or &lt;code>setspn&lt;/code>.&lt;/p>
&lt;p>setspn -a MSSQLSvc/DscSvr1.pomfret.com Pomfret\svc-dscsvr1-eng2
setspn -a MSSQLSvc/DscSvr1.pomfret.com:1433 Pomfret\svc-dscsvr1-eng2&lt;/p>
&lt;p>&lt;a class="link" href="https://jesspomfret.com/wp-content/uploads/2021/02/addSpn.jpg" target="_blank" rel="noopener"
>&lt;img src="https://jpomfret.github.io/images/addSpn.jpg"
loading="lazy"
>&lt;/a>&lt;/p>
&lt;p>You can see the output now states ‘Updated object’ which means we were successful. If we try and view the databases again now we should see the output we were expecting.&lt;/p>
&lt;p>&lt;a class="link" href="https://jesspomfret.com/wp-content/uploads/2021/02/Get-DbaDatabase.jpg" target="_blank" rel="noopener"
>&lt;img src="https://jpomfret.github.io/images/Get-DbaDatabase.jpg"
loading="lazy"
>&lt;/a>&lt;/p>
&lt;h2 id="summary">Summary&lt;/h2>
&lt;p>As I mentioned, this was not at all what I was expecting to write about – but I hope it’ll be useful if you ever find yourself in this situation while trying to change service accounts for SQL Server.&lt;/p>
&lt;p>I was in the end able to resolve the permissions problems for my service accounts by following this great blog post &amp;lsquo;&lt;a class="link" href="http://www.alexandreviot.net/2014/09/30/sql-server-could-not-register-the-service-principal-name-spn/" target="_blank" rel="noopener"
>SQL Server - Could not register the Service Principal Name&lt;/a>&amp;rsquo;. Once I applied these permissions when I changed service accounts they were able to delete and recreate the required SPNs.&lt;/p>
&lt;p>Another great blog post for more reading on SPNs is this post by &lt;a class="link" href="https://www.twitter.com/pittfurg" target="_blank" rel="noopener"
>Drew Furgiuele&lt;/a> on how to use the &lt;a class="link" href="https://dbatools.io/schwifty/" target="_blank" rel="noopener"
>dbatools SPN commands&lt;/a>.&lt;/p></description></item></channel></rss>