<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Last week, in Part 1, we talked about how to easily keep track of our resources with tags. There are many strategies for tagging your resources but I specifically focused on adding a â€˜dateCreatedâ€™ tag so we could see when resources were created â€“ since this isnâ€™t available by default.Â During that post we identified the biggest issue we had was that we were relying on a human to remember to add the â€˜dateCreatedâ€™ tag for every resource they created."><title>Keeping track of Azure resources with tags â€“ Part 2</title><link rel=canonical href=https://jpomfret.github.io/keeping-track-of-azure-resources-with-tags-part-2/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Keeping track of Azure resources with tags â€“ Part 2"><meta property="og:description" content="Last week, in Part 1, we talked about how to easily keep track of our resources with tags. There are many strategies for tagging your resources but I specifically focused on adding a â€˜dateCreatedâ€™ tag so we could see when resources were created â€“ since this isnâ€™t available by default.Â During that post we identified the biggest issue we had was that we were relying on a human to remember to add the â€˜dateCreatedâ€™ tag for every resource they created."><meta property="og:url" content="https://jpomfret.github.io/keeping-track-of-azure-resources-with-tags-part-2/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="azure"><meta property="article:tag" content="policy"><meta property="article:tag" content="powershell"><meta property="article:tag" content="tags"><meta property="article:published_time" content="2021-03-23T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-23T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Keeping track of Azure resources with tags â€“ Part 2"><meta name=twitter:description content="Last week, in Part 1, we talked about how to easily keep track of our resources with tags. There are many strategies for tagging your resources but I specifically focused on adding a â€˜dateCreatedâ€™ tag so we could see when resources were created â€“ since this isnâ€™t available by default.Â During that post we identified the biggest issue we had was that we were relying on a human to remember to add the â€˜dateCreatedâ€™ tag for every resource they created."><script async src="https://www.googletagmanager.com/gtag/js?id=G-YL15E7BXXF"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YL15E7BXXF",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#step-1--define-a-policy><strong>Step 1 â€“ Define a policy</strong></a></li><li><a href=#step-2--assign-the-policy><strong>Step 2 â€“ Assign the policy</strong></a></li><li><a href=#step-3--test-the-policy><strong>Step 3 â€“ Test the policy</strong></a></li><li><a href=#summary><strong>Summary</strong></a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/azure/>azure</a>
<a href=/categories/powershell/>powershell</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/keeping-track-of-azure-resources-with-tags-part-2/>Keeping track of Azure resources with tags â€“ Part 2</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Mar 23, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p>Last week, in <a class=link href=https://jesspomfret.com/azure-tags-part1/ target=_blank rel=noopener>Part 1</a>, we talked about how to easily keep track of our resources with tags. There are many strategies for tagging your resources but I specifically focused on adding a â€˜dateCreatedâ€™ tag so we could see when resources were created â€“ since this isnâ€™t available by default.Â  During that post we identified the biggest issue we had was that we were relying on a human to remember to add the â€˜dateCreatedâ€™ tag for every resource they created. Iâ€™ve got two ideas on how to fix that â€“ today weâ€™ll look at the first option, using <a class=link href=https://docs.microsoft.com/en-us/azure/governance/policy/overview target=_blank rel=noopener>Azure Policy</a>.</p><p>Azure Policy is a way of comparing your Azure estate to defined requirements. You can either use predefined definitions (of which there are many) or create your own specific rules.Â  These definitions can be assigned to certain scopes (subscriptions, resource groups). Azure Policy then reports on whether youâ€™re in the expected state and in some cases can alter resources to ensure you are.</p><h2 id=step-1--define-a-policy><strong>Step 1 â€“ Define a policy</strong></h2><p>In our example, all resources should have a â€˜dateCreatedâ€™ tag, and if Azure Policy finds the tag is missing, it should add that tag with the current date.</p><p>There are a few steps to set up our policy for ensuring the â€˜dateCreatedâ€™ tag exists on all resources. First we need to write a policy definition in JSON.Â  Donâ€™t panic yet though â€“ there are a lot of examples in the <a class=link href=https://github.com/Azure/azure-policy target=_blank rel=noopener>Azure/azure-policy</a> GitHub repo that we can start with.Â  By browsing the repo you can find the â€˜<a class=link href=https://github.com/Azure/azure-policy/tree/master/samples/Tags/add-tag target=_blank rel=noopener>add-tag</a>â€™ policy which is the perfect base for us to build off of.Â Â </p><p>When viewing that GitHub page there is a â€˜Deploy to Azureâ€™ button- clicking that (presuming youâ€™re logged into the portal) will take you straight to the â€˜New Policy Definitionâ€™ wizard where we can modify our policy to meet our needs and save it.Â </p><p>Youâ€™ll need to choose a â€˜Definition Locationâ€™ (which is the subscription this policy should reside in), name your policy, and edit the description if needed. The GitHub template has already specified this will go in the â€˜Tagsâ€™ category,but you can change that if youâ€™re keeping custom policies in a new category. Then we get to the policy rule, itâ€™s JSON time.</p><p>Since we imported the sample from GitHub the JSON is almost exactly what we need. The first section defines the rules and the second section defines parameters.Â  In this case weâ€™re going to remove the parameter section and change the tag name and values expected to be static. This means that the policy will only ever be used for adding the specific â€˜dateCreatedâ€™ tag.Â  The reason for this is weâ€™re going to add some logic to the tag value so it contains the current date. (It is possible that this can be achieved with parameters, but I couldnâ€™t get it to work. Please let me know in the comments if you know differently).Â </p><p>The JSON below is pretty simple. There are two main sections: the condition to be met and then the operation to carry out if the conditions are met.Â  In the conditions section weâ€™re looking to see if the dateCreated tag exists, if it doesnâ€™t weâ€™ll move onto the second section of the JSON. This defines what to do about it, and in this case itâ€™s pretty simple, weâ€™ll modify the target and add the dateCreated tag.Â  The tag value is dynamic and uses a <a class=link href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-functions target=_blank rel=noopener>resource manager template function</a> to get the current date.Â  There are a <a class=link href=https://docs.microsoft.com/en-us/azure/governance/policy/concepts/definition-structure#policy-functions target=_blank rel=noopener>few restrictions</a> on using functions within policy definitions, one being that we canâ€™t overload the uctNow function with a format parameter so weâ€™ll only be able to get a date in ISO 8601 (yyyyMMddTHHmmssZ) format.</p><p>{
&ldquo;mode&rdquo;: &ldquo;Indexed&rdquo;,
&ldquo;policyRule&rdquo;: {
&ldquo;if&rdquo;: {
&ldquo;field&rdquo;: &ldquo;tags[&lsquo;dateCreated&rsquo;]&rdquo;,
&ldquo;exists&rdquo;: &ldquo;false&rdquo;
},
&ldquo;then&rdquo;: {
&ldquo;effect&rdquo;: &ldquo;modify&rdquo;,
&ldquo;details&rdquo;: {
&ldquo;roleDefinitionIds&rdquo;: [
&ldquo;/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c&rdquo;
],
&ldquo;operations&rdquo;: [
{
&ldquo;operation&rdquo;: &ldquo;add&rdquo;,
&ldquo;field&rdquo;: &ldquo;tags[&lsquo;dateCreated&rsquo;]&rdquo;,
&ldquo;value&rdquo;: &ldquo;[utcNow()]&rdquo;
}
]
}
}
}
}</p><p>The final decision to make for our new policy definition is the â€˜Role definitionâ€™. Since our policy has remediation actions, the operation to add tags if needed, a <a class=link href=https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview target=_blank rel=noopener>managed identity</a> will be created for the policy.Â  The â€˜role definitionâ€™ is the permissions that will be granted to that managed identity.Â  The default is â€˜Contributorâ€™ which assigns â€˜full access to manage all resourcesâ€™. This can be changed based on what your policy needs access to.</p><h2 id=step-2--assign-the-policy><strong>Step 2 â€“ Assign the policy</strong></h2><p>Weâ€™ve now defined our policy, but the second part of this process is to assign that policy a scope. This outlines what this policy applies to. The scope can be a subscription or resource group, and can be more finely tuned by excluding specific resources that you donâ€™t want to apply the policy too.Â  Then itâ€™s as easy as selecting the policy we defined, setting an â€˜Assignment nameâ€™, which could be a combination of policy name and assigned score, and adding an optional description.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/03/assignPolicy.png target=_blank rel=noopener><img src=/images/assignPolicy.png loading=lazy alt="Assign policy screen in Azure"></a></p><h2 id=step-3--test-the-policy><strong>Step 3 â€“ Test the policy</strong></h2><p>The easiest way to test our policy is to create a resource without the â€˜dateCreatedâ€™ tag and see what happens. We have scoped our policy assignment to the â€˜policyTestâ€™ subscription so Iâ€™ll run the following PowerShell to create a new storage account thatâ€™s missing my required tag.</p><p>New-AzStorageAccount -ResourceGroupName policyTest -AccountName mystorageaccountjp77 -Location uksouth -SkuName Standard_GRS</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/03/createStorageAccount.png target=_blank rel=noopener><img src=/images/createStorageAccount-1024x124.png loading=lazy alt="create storage account with New-AzStorageAccount"></a></p><p>You can see there is no <code>-Tags</code> parameter specified, so this storage account was created without any tags. If we now run <code>Get-AzStorageAccount</code> we can see it has the &lsquo;dateCreated&rsquo; tag.</p><p>Get-AzStorageAccount -ResourceGroupName policyTest | Select-Object StorageAccountName, Tags</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/03/storageAccountTagged.png target=_blank rel=noopener><img src=/images/storageAccountTagged-1024x129.png loading=lazy alt="Get-AzStorageAccount results show the tags"></a></p><p>You can also see the tag in the portal view of our storage account.</p><p><img src=/images/storageAccountTaggedPortal.png loading=lazy></p><p>Finally, if we check out the Azure Policy we can see that we are in compliance. All resources in the â€˜policyTestâ€™ subscription have the required â€˜dateCreatedâ€™ tag.Â  We can also see the specific resources that are in compliance, in our case just the storage account we created.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/03/policyCompliance.png target=_blank rel=noopener><img src=/images/policyCompliance-1024x390.png loading=lazy></a></p><h2 id=summary><strong>Summary</strong></h2><p>This is just one option for automatically assigning the â€˜dateCreatedâ€™ tag on all new resources. In this case we scoped the policy to a specific resource group but have assigned it at the subscription level to cover all resources.Â  Note â€“ this is specifically to tag resources. If you want to also tag resource groups the policy definition will need to be altered slightly.</p><p>One downside of this method is I havenâ€™t found a way to control the format of the date in the tag value. This isnâ€™t a big concern but does lack a little flexibility, especially if we wanted to add the date in a different time zone.</p><p>Next week weâ€™ll look at adding the same functionality using Azure Functions to auto tag new resources.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/azure/>azure</a>
<a href=/tags/policy/>policy</a>
<a href=/tags/powershell/>powershell</a>
<a href=/tags/tags/>tags</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/keeping-track-of-azure-resources-with-tags-part-1/><div class=article-details><h2 class=article-title>Keeping track of Azure resources with tags â€“ Part 1</h2></div></a></article><article><a href=/dbachecks-and-azure-sql-databases/><div class=article-details><h2 class=article-title>dbachecks and Azure SQL Databases</h2></div></a></article><article><a href=/keeping-track-of-azure-resources-with-tags-part-3/><div class=article-details><h2 class=article-title>Keeping track of Azure resources with tags â€“ Part 3</h2></div></a></article><article class=has-image><a href=/ad-powershell-domain/><div class=article-image><img src=/ad-powershell-domain/cover.1f6e3c7a515e11da6cb002af63610e16_hu13e3ae6f863033d0af17372d9ca75135_471265_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Run ActiveDirectory PowerShell commands against another domain" data-key=ad-powershell-domain data-hash="md5-H248elFeEdpssAKvY2EOFg=="></div><div class=article-details><h2 class=article-title>Run ActiveDirectory PowerShell commands against another domain</h2></div></a></article><article class=has-image><a href=/log-ship-staged/><div class=article-image><img src=/log-ship-staged/cover.f4ab6d164035c79e896561924d558d00_hufa84d3a6e624ae2b3ca125fbcc0da73a_679878_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Log Shipping â€“ Pre-stage database backups with dbatools" data-key=log-ship-staged data-hash="md5-9KttFkA1x56JZWGSTVWNAA=="></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>