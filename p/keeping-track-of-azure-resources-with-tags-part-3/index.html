<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This is now the third post in a series on Azure tags. You can read the other two posts here to get up to speed with where weâ€™ve been, however that isnâ€™t required for this post .
Keeping track of Azure resources with tags â€“ Part 1 Keeping track of Azure resources with tags â€“ Part 2 In part one I discussed how useful Azure tags can be, and specifically about how adding a â€˜dateCreatedâ€™ tag can help you keep track of your resources, and how to find resources with certain tags using PowerShell."><title>Keeping track of Azure resources with tags â€“ Part 3</title><link rel=canonical href=https://jpomfret.github.io/p/keeping-track-of-azure-resources-with-tags-part-3/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Keeping track of Azure resources with tags â€“ Part 3"><meta property="og:description" content="This is now the third post in a series on Azure tags. You can read the other two posts here to get up to speed with where weâ€™ve been, however that isnâ€™t required for this post .
Keeping track of Azure resources with tags â€“ Part 1 Keeping track of Azure resources with tags â€“ Part 2 In part one I discussed how useful Azure tags can be, and specifically about how adding a â€˜dateCreatedâ€™ tag can help you keep track of your resources, and how to find resources with certain tags using PowerShell."><meta property="og:url" content="https://jpomfret.github.io/p/keeping-track-of-azure-resources-with-tags-part-3/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2021-03-31T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-31T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Keeping track of Azure resources with tags â€“ Part 3"><meta name=twitter:description content="This is now the third post in a series on Azure tags. You can read the other two posts here to get up to speed with where weâ€™ve been, however that isnâ€™t required for this post .
Keeping track of Azure resources with tags â€“ Part 1 Keeping track of Azure resources with tags â€“ Part 2 In part one I discussed how useful Azure tags can be, and specifically about how adding a â€˜dateCreatedâ€™ tag can help you keep track of your resources, and how to find resources with certain tags using PowerShell."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#step-1---create-a-function>Step 1 - Create a function</a></li></ol><ol><li><a href=#step-2---add-a-managed-identity>Step 2 - Add a managed identity</a></li><li><a href=#step-3---test-our-function>Step 3 - Test our function</a></li><li><a href=#summary>Summary</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/azure/>azure</a>
<a href=/categories/powershell/>powershell</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/keeping-track-of-azure-resources-with-tags-part-3/>Keeping track of Azure resources with tags â€“ Part 3</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Mar 31, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p>This is now the third post in a series on Azure tags. You can read the other two posts here to get up to speed with where weâ€™ve been, however that isnâ€™t required for this post .</p><ul><li><a class=link href=https://jesspomfret.com/azure-tags-part1/ target=_blank rel=noopener>Keeping track of Azure resources with tags â€“ Part 1</a></li><li><a class=link href=https://jesspomfret.com/azure-tags-part2/ target=_blank rel=noopener>Keeping track of Azure resources with tags â€“ Part 2</a></li></ul><p>In part one I discussed how useful Azure tags can be, and specifically about how adding a â€˜dateCreatedâ€™ tag can help you keep track of your resources, and how to find resources with certain tags using PowerShell.Â  Part 2 and 3 are based around the fact that adding the â€˜dateCreatedâ€™ tag is a great idea, but relying on a human to remember to add it is less than ideal. In part 2 we looked at using Azure Policy to automatically add the tag. Todayâ€™s post will cover another option using Azure Functions.</p><p>Azure Functions gives us a way of running serverless code, written in a number of different languages, triggered by specific events or timings.Â  Looking through the <a class=link href=https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview target=_blank rel=noopener>documentation</a> there are many use cases from processing files to analysing IoT workstreams.Â  Our use case is to run a PowerShell script that tags any resources that are missing the â€˜dateCreatedâ€™.</p><h2 id=step-1---create-a-function>Step 1 - Create a function</h2><p>Azure Functions live within a function app, so the first thing we have to do is create this logical container. At this level weâ€™ll decide on a â€˜Function App nameâ€™, Iâ€™ve called mine â€˜resourceTagJpâ€™, and choosing â€˜Codeâ€™ for the publish option we can then choose PowerShell as our language of choice. There are some other options for selecting a storage account and configuring â€˜Application Insightsâ€™, but for now Iâ€™ve left those all as the defaults.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/03/functionApp.png target=_blank rel=noopener><img src=/images/functionApp.png loading=lazy alt="create a function app pane"></a></p><p>Once the â€˜Function Appâ€™ is created we are ready to create our function.Â  On the left hand pane choose â€˜Functionsâ€™ and then â€˜Addâ€™. This will open a pane for you to choose how to develop the function, either in the portal or on your local machine in VSCode, for example, and the template to base your function off of.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/03/CreateFunction-1.png target=_blank rel=noopener><img src=/images/CreateFunction-1.png loading=lazy alt="Create an Azure Function"></a></p><p>One of the simplest options is to choose â€˜Timer Triggerâ€™, which as expected will execute the function code based on a schedule. The schedule is set using a cron expression. For it to run once an hour at the top of the hour weâ€™ll use the following:</p><p>0 0 * * * *</p><p><img src=/images/cronSchedule.png loading=lazy alt="cron schedule popup"></p><p>Once the function is created weâ€™ll choose â€˜Code + Testâ€™ on the left hand pane of the portal to actually add the function code. The code for my function is going to be pretty simple, but if you are writing more complicated functions there is a <a class=link href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions" target=_blank rel=noopener>VSCode extension</a> that can be used to develop and test functions locally before publishing them to Azure.</p><p>We have three files within our function:</p><ul><li>Readme.md â€“ for documentation in markdown</li><li>Function.json â€“ the config file, currently contains our timer binding information</li><li>Run.ps1 â€“ the main function code, in PowerShell as thatâ€™s what we chose</li></ul><p>The code for the function is below and makes use of the <code>Update-AzTag</code> cmdlet to add the â€˜dateCreatedâ€™ tag. In this example, since Iâ€™m using PowerShell, I can easily format the date to be exactly how I want it to be displayed. If you read part 2 in this series, that was a downfall of using Azure Policy, I only had one datetime format option. The <code>Update-AzTag</code> also has a <code>-Merge</code> parameter which ensures any tags already on the resource arenâ€™t overwritten by this function.</p><p># Input bindings are passed in via param block.
param($Timer)</p><h1 id=select-the-subscription>Select the subscription</h1><p>$null = Select-AzSubscription -SubscriptionId (Get-AzSubscription -SubscriptionName &lsquo;MSDN Platforms&rsquo;)</p><h1 id=tag-any-resources-that-are-missing-tags>tag any resources that are missing tags</h1><p>$res = Get-AzResource -ResourceGroupName functionTest | Where { $_.tags.keys -notcontains &lsquo;dateCreated&rsquo; }
$res.Foreach{
Update-AzTag -ResourceId $psitem.ResourceId -Tag @{&lsquo;dateCreated&rsquo; = (Get-Date -Format &ldquo;yyyy-MM-dd&rdquo;)} -Operation Merge
}</p><p>Thatâ€™s all it is to create our function â€“ however, it doesnâ€™t currently have the authorisation to view or update resources.</p><h2 id=step-2---add-a-managed-identity>Step 2 - Add a managed identity</h2><p>To provision access to allow our function to work we can make use of <a class=link href="https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=dotnet" target=_blank rel=noopener>Azure Managed Identities</a>. These are similar to Managed Service Accounts in that there is no need to set or rotate passwords. This means we can configure our function with a managed identity and then forget about it- we know itâ€™ll remain secure and the password/secret will be rotated often.</p><p>There are two options for managed identities: system-assigned or user-assigned. The system-assigned identity is tied directly to your application â€“ if we delete the function the identity will also be deleted, and thatâ€™s fine for this purpose.</p><p>Configuring the system-assigned identity is pretty straightforward. On our function pane under identity, change the status to â€˜Onâ€™.Â  After a couple of minutes the identity will be deployed and youâ€™ll see the option to assign â€˜Azure role assignmentsâ€™.</p><p>Clicking on â€˜Azure role assignmentsâ€™ will open a pane where you can assign whatever permissions your function will need to run. This can be scoped at the subscription or resource group level. For this example my function is just tagging anything within the â€˜functionTestâ€™ resource group so I can set the permissions to that scope.Â  I have chosen the â€˜contributorâ€™ role as that gives us enough permissions to view and tag resources.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/03/ManagedIdentity.png target=_blank rel=noopener><img src=/images/ManagedIdentity.png loading=lazy alt="Setting up a system assigned managed identity for our function"></a></p><h2 id=step-3---test-our-function>Step 3 - Test our function</h2><p>We have created our function and set up the managed identity to enable the function to access our resources, now itâ€™s time to make sure itâ€™s working as expected. From the â€˜Code + Testâ€™ page there is a â€˜Test/Runâ€™ at the top that brings out the pane on the right. In that pane pressing run will simulate the time trigger being met and our function executing.</p><p>In the console you can see exactly what the function does and any output youâ€™ve configured â€“ in this example you can see a storage account was tagged.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/03/TestFunction-1.png target=_blank rel=noopener><img src=/images/TestFunction-1.png loading=lazy></a></p><p>We can also test this function by creating an untagged resource in the â€˜functionTestâ€™ resource group and waiting for the timer to be triggered.</p><p>However we test our function we can see the tag is now on our storage account and we no longer have to rely on a human to remember the tag when they create resources.</p><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2021/03/storageAccountFunctionTagged.png target=_blank rel=noopener><img src=/images/storageAccountFunctionTagged.png loading=lazy alt="Showing a storage account has been tagged with our specified date format"></a></p><h2 id=summary>Summary</h2><p>This has been as much a learning experience for me as it hopefully has been for you. My journey into Azure is still pretty new but Iâ€™m enjoying the adventure.</p><p>To wrap this up, having a tagging strategy is important and there are multiple ways to ensure that tagging strategy is followed. Both Azure Policy and Azure Functions give us a good option for automatically tagging resources that are missing tags. If youâ€™re using Terraform to deploy Azure resources <a class=link href=https://jqmartin.info/2021/03/02/terraform-timestamps-and-tagging/ target=_blank rel=noopener>John Martin has written about adding the a tag for date created to all resources as they are deployed</a>, which is definitely worth a read.</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/keeping-track-of-azure-resources-with-tags-part-2/><div class=article-details><h2 class=article-title>Keeping track of Azure resources with tags â€“ Part 2</h2></div></a></article><article><a href=/p/keeping-track-of-azure-resources-with-tags-part-1/><div class=article-details><h2 class=article-title>Keeping track of Azure resources with tags â€“ Part 1</h2></div></a></article><article><a href=/p/dbachecks-and-azure-sql-databases/><div class=article-details><h2 class=article-title>dbachecks and Azure SQL Databases</h2></div></a></article><article class=has-image><a href=/p/run-activedirectory-powershell-commands-against-another-domain/><div class=article-image><img src=/cover.jpg loading=lazy data-key data-hash=/cover.jpg></div><div class=article-details><h2 class=article-title>Run ActiveDirectory PowerShell commands against another domain</h2></div></a></article><article class=has-image><a href=/p/log-ship-staged/><div class=article-image><img src=/cover.jpg loading=lazy data-key=log-ship-staged data-hash=/cover.jpg></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>