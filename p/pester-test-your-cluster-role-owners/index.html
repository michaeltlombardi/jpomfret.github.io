<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In an ideal situation it probably shouldnâ€™t matter which node of a failover cluster your resources and roles are hosted on, but the real world is often far from ideal.Â This post will talk through how we can record the current owner nodes and then use Pester to ensure weâ€™re in the ideal configuration. This could be useful post maintenance activities or as a daily check to ensure things are as you expect."><title>Pester test your Cluster Role Owners</title><link rel=canonical href=https://jpomfret.github.io/p/pester-test-your-cluster-role-owners/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Pester test your Cluster Role Owners"><meta property="og:description" content="In an ideal situation it probably shouldnâ€™t matter which node of a failover cluster your resources and roles are hosted on, but the real world is often far from ideal.Â This post will talk through how we can record the current owner nodes and then use Pester to ensure weâ€™re in the ideal configuration. This could be useful post maintenance activities or as a daily check to ensure things are as you expect."><meta property="og:url" content="https://jpomfret.github.io/p/pester-test-your-cluster-role-owners/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="clusters"><meta property="article:tag" content="pester"><meta property="article:tag" content="powershell"><meta property="article:published_time" content="2020-09-29T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-29T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Pester test your Cluster Role Owners"><meta name=twitter:description content="In an ideal situation it probably shouldnâ€™t matter which node of a failover cluster your resources and roles are hosted on, but the real world is often far from ideal.Â This post will talk through how we can record the current owner nodes and then use Pester to ensure weâ€™re in the ideal configuration. This could be useful post maintenance activities or as a daily check to ensure things are as you expect."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#step-1--store-the-current-resource-owners><strong>Step 1 â€“ Store the current resource owners</strong></a></li><li><a href=#step-2--test-the-current-configuration><strong>Step 2 â€“ Test the current configuration</strong></a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/pester/>pester</a>
<a href=/categories/powershell/>powershell</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/pester-test-your-cluster-role-owners/>Pester test your Cluster Role Owners</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 29, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>In an ideal situation it probably shouldnâ€™t matter which node of a failover cluster your resources and roles are hosted on, but the real world is often far from ideal.Â  This post will talk through how we can record the current owner nodes and then use Pester to ensure weâ€™re in the ideal configuration. This could be useful post maintenance activities or as a daily check to ensure things are as you expect.</p><h2 id=step-1--store-the-current-resource-owners><strong>Step 1 â€“ Store the current resource owners</strong></h2><p>If we are going to test that weâ€™re in our expected configuration, we need to record what that configuration looks like.Â  I have a hard coded list of cluster names. However, you could easily pull them from a text file, or a database.Â  Once we have the list of clusters we can use <code>Get-ClusterGroup</code> to determine the cluster roles and their current owners.</p><p>To persist this owner information Iâ€™m using <code>ConvertTo-Json</code> and then outputting it to a file. This creates a file that can easily be read back into PowerShell as an object using <code>ConvertFrom-Json</code>.</p><p>Itâ€™s also probably worth mentioning that this ideal configuration can be stored in source control. Thatâ€™ll keep the file safe and you can easily keep track of any changes that are made to it.</p><p>$clusters = â€˜ClusterName1â€™,â€™ClusterName2â€™
$owners = $clusters | % { Get-ClusterGroup -Cluster $PSItem | select Cluster, Name, State, OwnerNode }
$owners | % {
[PSCustomObject] @{
Cluster = $_.Cluster.Name
Name = $_.Name
OwnerNode = $_.OwnerNode.Name
State = $_.State -as [string]
}
} | ConvertTo-Json | Out-File ClusterGroupOwners.json</p><p>Youâ€™ll notice Iâ€™m creating a <code>PSCustomObject</code> to pipe to the <code>ConvertTo-Json</code>. Without that, the object from <code>Get-ClusterGroup</code> is exploded, with all properties, including nested properties exported into the JSON output. This is more than we need, and I think there is some value in having a clear concise output file.Â </p><p>Iâ€™m also using <code>-as [string]</code> on the state property. PowerShell automatically translates the real state to a text value when outputted as itâ€™s an enumeration type â€“ but when you pipe that to <code>ConvertTo-Json</code> you get the raw integer value.</p><h2 id=step-2--test-the-current-configuration><strong>Step 2 â€“ Test the current configuration</strong></h2><p>When itâ€™s time to test our configuration we can read in our ClusterGroupOwners.json and then convert it back to a PowerShell object using <code>ConvertFrom-Json</code>.Â  Now we have a PowerShell object of our ideal configuration we can loop through each cluster, checking the current group owners using <code>Get-ClusterGroup</code> again.Â  This current state can then be matched against the desired configuration.</p><p>I am using a pretty simple pester test for this work, saving it as Check-ClusterOwners.tests.ps1.</p><p>$desiredConfig = Get-Content ClusterGroupOwners.json | ConvertFrom-Json
$clusters = $desiredConfig | Select -Unique Cluster</p><p>Describe &lsquo;The cluster resources should be owned by the same node as before&rsquo; -Tag ClusterOwner {
Foreach ($cls in $clusters) {
Context (&lsquo;Cluster owners are the same for {0}&rsquo; -f $cls.Cluster) {
$groups = $desiredConfig | Where-Object Cluster -eq $cls.Cluster
$currentOwner = Get-ClusterGroup -Cluster $cls.Cluster
foreach ($grp in $groups) {
It (&rsquo;{0} should be owned by {1}&rsquo; -f $grp.Name, $grp.OwnerNode) {
($currentOwner | Where-Object name -eq $grp.name).OwnerNode.Name | Should -Be $grp.OwnerNode
}
}
}
}
}</p><p>Weâ€™ll call this test using <code>Invoke-Pester .\Check-ClusterOwners.tests.ps1</code>.</p><p>If everything is as expected weâ€™ll get output similar to this for each cluster â€“ depending on the resources you have set up in your cluster.</p><p>Describing The cluster resources should be owned by the same node as before
Context Cluster owners are the same for clustername
[+] RoleName should be owned by nodename 56ms
[+] RoleName2 should be owned by nodename 92ms</p><p>If you have a resource that is not on the node that is expected, youâ€™ll easily be able to see that in the output:</p><p>Context Cluster owners are the same for clusterName
[-] RoleName should be owned by NodeB 102ms
Expected strings to be the same, but they were different.
String lengths are both 13.
Strings differ at index 12.
Expected: &lsquo;NodeB&rsquo;
But was: &lsquo;NodeA&rsquo;
13: ($currentOwner | Where-Object name -eq $grp.name).OwnerNode.Name | Should -Be $grp.OwnerNode</p><p>This method of testing can be useful to ensure youâ€™re in the ideal state in many scenarios. For example you could store any databases in your estate that are not â€˜onlineâ€™ and then confirm post reboots/patching that all the databases are in the expected state.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/clusters/>clusters</a>
<a href=/tags/pester/>pester</a>
<a href=/tags/powershell/>powershell</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/keeping-the-demo-gods-at-bay-with-pester/><div class=article-details><h2 class=article-title>Keeping the demo gods at bay with Pester</h2></div></a></article><article><a href=/p/t-sql-tuesday-#135-the-outstanding-tools-of-the-trade-that-make-your-job-awesome/><div class=article-details><h2 class=article-title>T-SQL Tuesday #135: The outstanding tools of the trade that make your job awesome</h2></div></a></article><article class=has-image><a href=/p/run-activedirectory-powershell-commands-against-another-domain/><div class=article-image><img src=/cover.jpg loading=lazy data-key data-hash=/cover.jpg></div><div class=article-details><h2 class=article-title>Run ActiveDirectory PowerShell commands against another domain</h2></div></a></article><article class=has-image><a href=/p/log-ship-staged/><div class=article-image><img src=/cover.jpg loading=lazy data-key=log-ship-staged data-hash=/cover.jpg></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article><article><a href=/p/collating-index-usage-stats-across-availability-group-replicas/><div class=article-details><h2 class=article-title>Collating index usage stats across Availability Group replicas</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>