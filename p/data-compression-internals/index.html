<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Last year I gave my first user group presentation on data compression and since then Iâ€™ve also given this talk at both SQL Saturday Columbus 2018 and SQL Saturday Cleveland 2019. One of my favourite demos from the presentation is taking a look under the covers to see what SQL Server does with compressed data at the page level. This blog post is going to walk through this demo.Â If youâ€™d like to follow along you can pull down my docker image and have your own environment up and running in no time."><title>Data Compression Internals</title><link rel=canonical href=https://jpomfret.github.io/p/data-compression-internals/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Data Compression Internals"><meta property="og:description" content="Last year I gave my first user group presentation on data compression and since then Iâ€™ve also given this talk at both SQL Saturday Columbus 2018 and SQL Saturday Cleveland 2019. One of my favourite demos from the presentation is taking a look under the covers to see what SQL Server does with compressed data at the page level. This blog post is going to walk through this demo.Â If youâ€™d like to follow along you can pull down my docker image and have your own environment up and running in no time."><meta property="og:url" content="https://jpomfret.github.io/p/data-compression-internals/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="data-compression"><meta property="article:published_time" content="2019-02-19T00:00:00+00:00"><meta property="article:modified_time" content="2019-02-19T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Data Compression Internals"><meta name=twitter:description content="Last year I gave my first user group presentation on data compression and since then Iâ€™ve also given this talk at both SQL Saturday Columbus 2018 and SQL Saturday Cleveland 2019. One of my favourite demos from the presentation is taking a look under the covers to see what SQL Server does with compressed data at the page level. This blog post is going to walk through this demo.Â If youâ€™d like to follow along you can pull down my docker image and have your own environment up and running in no time."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#compression-level-none>Compression Level: None</a></li><li><a href=#compression-level-row>Compression Level: Row</a></li><li><a href=#compression-level-page>Compression Level: Page</a></li><li><a href=#summary>Summary</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/data-compression/>data-compression</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/data-compression-internals/>Data Compression Internals</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Feb 19, 2019</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><p>Last year I gave my first user group presentation on data compression and since then Iâ€™ve also given this talk at both SQL Saturday Columbus 2018 and SQL Saturday Cleveland 2019. One of my favourite demos from the presentation is taking a look under the covers to see what SQL Server does with compressed data at the page level. This blog post is going to walk through this demo.Â  If youâ€™d like to follow along you can pull down my docker image and have your own environment up and running in no time. As long as you already have docker running on your machine you can use the following to get setup and the full demo script is available on <a class=link href=https://github.com/jpomfret/demos/blob/master/DataCompression/01_Page_Internals.sql target=_blank rel=noopener>GitHub</a>.</p><p>docker pull jpomfret7/datacompression:demo</p><p>docker run -e ACCEPT_EULA=Y -e SA_PASSWORD=$SaPwd -p 1433:1433 -d jpomfret7/datacompression:demo</p><p>Iâ€™m using an empty database to start this demo so you only really need my containerized environment for the end when we need to load some more sample data.</p><p>Within my empty database, named <code>CompressTest</code>, I first create a simple table named <code>employee</code> and insert three rows. A couple of important things to note on this table. Firstly, the datatypes Iâ€™ve chosen are all fixed length, and the values inserted leave a lot of empty space. Secondly, there are a few examples of repeating data, both in the name columns and the city.Â  These conditions make this table a great candidate for both row and page compression.</p><p>USE CompressTest
GO</p><p>CREATE TABLE employee (
employeeId bigint PRIMARY KEY,
firstName char(100),
lastName char(100),
address1 char(250),
city char(50)
)</p><p>INSERT INTO employee
values (1, &lsquo;Alex&rsquo;,&lsquo;Young&rsquo;,&lsquo;2 Sand Run&rsquo;,&lsquo;Akron&rsquo;),
(2, &lsquo;Richard&rsquo;,&lsquo;Young&rsquo;,&lsquo;77 High St.&rsquo;,&lsquo;Akron&rsquo;),
(3, &lsquo;Alexis&rsquo;,&lsquo;Young&rsquo;,&lsquo;1 First Ave.&rsquo;,&lsquo;Richfield&rsquo;)</p><h3 id=compression-level-none>Compression Level: None</h3><p>Once we have our table created we need to use a couple of undocumented, but widely used commands to view the underlying page. Step one is to find the page that contains our data. We&rsquo;ll use <code>DBCC IND</code> for this and pass in our database and table name.</p><p>DBCC IND (&lsquo;CompressTest&rsquo;, &rsquo;employee&rsquo;, 1);</p><p><img src=/images/DBCC_IND.jpg loading=lazy></p><p>The <code>employee</code> table has two types of pages shown here. The <code>PageType</code> of 1 is our data page and the one we are interested in today. Once we have our <code>PageFID (1)</code> and <code>PagePID (376)</code>, weâ€™ll take these values and use them as parameters for <code>DBCC PAGE</code>.</p><p>We first need to switch on trace flag <code>3604</code>: this will write the output of our <code>DBCC PAGE</code> command to the messages tab instead of the event log.</p><p>There are 4 parameters for <code>DBCC PAGE</code>: we will need to pass in the database name (or id), the file number, the page id and the print option.Â  Using a print option of 0 will give us just the page header. In these examples Iâ€™m going to use option 3 which gives us more details on the rows stored on the page. For more information on using <code>DBCC PAGE</code> Iâ€™d recommend Paul Randalâ€™s post &ldquo;<a class=link href=https://blogs.msdn.microsoft.com/sqlserverstorageengine/2006/06/10/how-to-use-dbcc-page/ target=_blank rel=noopener>How to use DBCC PAGE</a>&rdquo;.</p><p>We will run the following to inspect our page:</p><p>DBCC TRACEON (3604);
GO
DBCC PAGE(&lsquo;CompressTest&rsquo;,1,376,3)</p><p>There is a lot of information returned. Before you get overwhelmed, we are only going to look at a few data points from this so we can show the changes as we apply compression.Â  If you are interested in learning more about page internals, another Paul Randal post worth checking out is &ldquo;<a class=link href=https://www.sqlskills.com/blogs/paul/inside-the-storage-engine-anatomy-of-a-page/%ef%bb%bf target=_blank rel=noopener>Inside the Storage Engine: Anatomy of a page</a>&rdquo;.</p><p>From the output below weâ€™ll note the following: the <code>pminlin</code> (the size of the fixed length data fields) is 512, the <code>m_slotCnt</code> (the number of records on the page) is 3, and finally the <code>m_freeCnt</code> (the number of free bytes on the page) is 6545.</p><p><img src=/images/DBCC_PAGE_NONE.jpg loading=lazy></p><p>Since we used option 3 for <code>DBCC PAGE</code> we can also scroll down and see the data on our pages. The first record is below and is currently 515 bytes, and you can see on the right there is a lot of unused space.</p><p><img src=/images/DBCC_PAGE_RECORD_NONEjpg.jpg loading=lazy></p><h3 id=compression-level-row>Compression Level: Row</h3><p>Weâ€™ll now take our employees table and apply <code>ROW</code> compression to the clustered index. This physically changes how the data is stored on the page.Â  Any fixed length datatypes will now be stored in variable length fields where the data only uses the minimum number of bytes needed.</p><p>ALTER TABLE employee REBUILD PARTITION = ALL
WITH (DATA_COMPRESSION = ROW)</p><p>When compression is applied the pages are rewritten to disk, we need to use <code>DBCC IND</code> to retrieve the new page information:</p><p>DBCC IND (&lsquo;CompressTest&rsquo;, &rsquo;employee&rsquo;, 1);</p><p><img src=/images/DBCC_IND_ROW.jpg loading=lazy></p><p>We then use these values for <code>DBCC PAGE</code>. The trace flag we set earlier is good for the session, therefore if weâ€™re in the same query window we donâ€™t need to rerun that command.</p><p>DBCC PAGE(&lsquo;CompressTest&rsquo;,1,384,3)</p><p><img src=/images/DBCC_PAGE_ROW.jpg loading=lazy></p><p>Now that our table is ROW compressed you can see the <code>pminlength</code> is only 5, this is reduced from 512 when our table wasnâ€™t compressed. You can also note <code>m_slotCnt</code> is still 3, which is expected, and the amount of free space on the page <code>m_freeCnt</code> has increased to 7971.</p><p>If we again scroll down to inspect our first row we can see it is now only 35 bytes and the highlighted area on the right clearly shows that the unused space within our row has been removed.</p><p><img src=/images/DBCC_PAGE_RECORD_ROW.jpg loading=lazy></p><h3 id=compression-level-page>Compression Level: Page</h3><p>Our final type of compression is <code>PAGE</code> compression. This compresses the data using three steps:</p><ol><li>Row compression: removing any wasted space from fixed length datatypes as we have already seen.</li><li>Prefix compression: the engine will look for repeating data at the start of each column on each page and store that once in the anchor record.Â  Each row will then store a pointer back to that anchor record which is stored within the compression information section of the page.</li><li>Dictionary compression: similar to prefix compression except the repeating data can be anywhere on the page instead of being restricted to the same column.</li></ol><p>ALTER TABLE employee REBUILD PARTITION = ALL
WITH (DATA_COMPRESSION = PAGE</p><p>Running <code>DBCC IND</code> again will get us our newly written page:</p><p>DBCC IND (&lsquo;CompressTest&rsquo;, &rsquo;employee&rsquo;, 1);</p><p><img src=/images/DBCC_IND_PAGE.jpg loading=lazy></p><p>Weâ€™ll examine it with <code>DBCC PAGE</code>:</p><p>DBCC PAGE(&lsquo;CompressTest&rsquo;,1,376,3)</p><p><img src=/images/DBCC_PAGE_PAGE.jpg loading=lazy></p><p>The interesting thing here is that nothing has changed, but if I check the DMVs the <code>employee</code> table shows as <code>PAGE</code> compressed.</p><p>Use CompressTest</p><p>SELECT
schema_name(obj.SCHEMA_ID) as SchemaName,
obj.name as TableName,
ind.name as IndexName,
ind.type_desc as IndexType,
pas.row_count as NumberOfRows,
pas.used_page_count as UsedPageCount,
(pas.used_page_count * 8)/1024 as SizeUsedMB,
par.data_compression_desc as DataCompression,
(pas.reserved_page_count * 8)/1024 as SizeReservedMB
FROM sys.objects obj
INNER JOIN sys.indexes ind
ON obj.object_id = ind.object_id
INNER JOIN sys.partitions par
ON par.index_id = ind.index_id
AND par.object_id = obj.object_id
INNER JOIN sys.dm_db_partition_stats pas
ON pas.partition_id = par.partition_id
WHERE obj.schema_id &lt;> 4
ORDER BY SizeUsedMB desc</p><p><img src=/images/dmvs.jpg loading=lazy></p><p>SQL Server outsmarted us a little here. I have only inserted three rows into the employee table and we know after looking at the <code>DBCC PAGE</code> output that there is plenty of free space on this page.Â  SQL Server will only apply PAGE compression if it needs to as there is a higher CPU cost to use prefix and dictionary compression. If page compression isnâ€™t going to save any pages the engine leaves the table with just <code>ROW</code> compression applied.</p><p>Running the following will insert 200 more rows into my employee table. Iâ€™m getting the data from the <code>vEmployee</code> view within <code>AdventureWorks2017</code>.</p><p>INSERT INTO employee (employeeId, firstName,lastName, address1, city)
SELECT TOP 200 BusinessEntityID, FirstName, LastName, AddressLine1, CITY
FROM AdventureWorks2017.HumanResources.vEmployee
WHERE BusinessEntityID > 3</p><p>Now when I run <code>DBCC IND</code> I can see the employee table uses four pages, two of them being data pages.</p><p>DBCC IND (&lsquo;CompressTest&rsquo;, &rsquo;employee&rsquo;, 1);</p><p><img src=/images/DBCC_IND_FINAL.jpg loading=lazy></p><p>Finally, weâ€™ll look at <code>DBCC PAGE</code> to see page compression in action:</p><p>DBCC PAGE(&lsquo;CompressTest&rsquo;,1,376,3)</p><p><img src=/images/DBCC_PAGE_FINAL.jpg loading=lazy></p><p>You can now see there are 102 rows on our page (<code>m_slotCnt</code>) and our fixed length data types are still 5 (<code>pminlen</code>). Directly after the page header is the compression information section. You can see on the right that repeating data values have been pulled out and stored here.Â  There are two possible <code>CI Header Flags</code> and they are both set here. <code>CI_HAS_ANCHOR_RECORD</code> shows that prefix compression has been used and <code>CI_HAS_DICTIONARY</code> shows that dictionary compression has been used.</p><p><img src=/images/compressionInfo_Page-1.jpg loading=lazy></p><p>If I scroll down a little further, Iâ€™ll come to the first row. The record is now only 24 bytes and you can see that a lot of the data has been replaced. The values <code>Alex</code>, <code>Young</code> and <code>Akron</code> all now reside in the compression information and this record just contains pointers.</p><p><img src="https://i2.wp.com/jesspomfret.com/wp-content/uploads/2019/02/DBCC_PAGE_RECORD_PAGE.jpg?fit=650%2C206&ssl=1" loading=lazy></p><h3 id=summary>Summary</h3><p>Itâ€™s easy to just apply compression to your databases and see massive space savings. This post hopes to shed a little light on what happens to your pages when using row and page compression. I recently gave this talk to the DBA Fundamentals virtual chapter so if youâ€™d like to see the rest the recording is available on <a class=link href="http://%ef%bb%bfhttps://www.youtube.com/watch?v=F02NqGP2Gyg" target=_blank rel=noopener>YouTube</a>.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/data-compression/>data-compression</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/data-compression-demos-in-containers/><div class=article-details><h2 class=article-title>Data Compression Demos in Containers</h2></div></a></article><article><a href=/p/data-compression--backup-compression-double-compression/><div class=article-details><h2 class=article-title>Data Compression + Backup Compression = Double Compression?</h2></div></a></article><article><a href=/p/t-sql-tuesday-#104-code-you-cant-live-without/><div class=article-details><h2 class=article-title>T-SQL Tuesday #104 â€“ Code you can't live without</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>