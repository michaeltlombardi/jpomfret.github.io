<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Automation is something that interests me greatly, and I think if you have read even one of my previous posts youâ€™ll know that my favorite tool for this kind of work is PowerShell.Â This is the perfect topic to kick off T-SQL Tuesday for 2019 so thanks goes to Garry Bargsley for hosting this month.
One of my goals for 2019 is to improve our server build process, itâ€™s currently reasonably well scripted but there are some definite gaps."><title>T-SQL Tuesday #110 - "Automate All the Things"</title><link rel=canonical href=https://jpomfret.github.io/p/t-sql-tuesday-#110-automate-all-the-things/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="T-SQL Tuesday #110 - &#34;Automate All the Things&#34;"><meta property="og:description" content="Automation is something that interests me greatly, and I think if you have read even one of my previous posts youâ€™ll know that my favorite tool for this kind of work is PowerShell.Â This is the perfect topic to kick off T-SQL Tuesday for 2019 so thanks goes to Garry Bargsley for hosting this month.
One of my goals for 2019 is to improve our server build process, itâ€™s currently reasonably well scripted but there are some definite gaps."><meta property="og:url" content="https://jpomfret.github.io/p/t-sql-tuesday-#110-automate-all-the-things/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="automation"><meta property="article:tag" content="dsc"><meta property="article:tag" content="powershell"><meta property="article:published_time" content="2019-01-08T00:00:00+00:00"><meta property="article:modified_time" content="2019-01-08T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="T-SQL Tuesday #110 - &#34;Automate All the Things&#34;"><meta name=twitter:description content="Automation is something that interests me greatly, and I think if you have read even one of my previous posts youâ€™ll know that my favorite tool for this kind of work is PowerShell.Â This is the perfect topic to kick off T-SQL Tuesday for 2019 so thanks goes to Garry Bargsley for hosting this month.
One of my goals for 2019 is to improve our server build process, itâ€™s currently reasonably well scripted but there are some definite gaps."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#powershell-desired-state-configuration>PowerShell Desired State Configuration</a></li><li><a href=#writing-our-first-configuration>Writing our First Configuration</a></li><li><a href=#using-composite-resources>Using Composite Resources</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/dsc/>dsc</a>
<a href=/categories/powershell/>powershell</a>
<a href=/categories/t-sql-tuesday/>t-sql-tuesday</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/t-sql-tuesday-#110-automate-all-the-things/>T-SQL Tuesday #110 - "Automate All the Things"</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 08, 2019</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><p><a class=link href=https://garrybargsley.com/t-sql-tuesday-110-automate-all-the-things/ target=_blank rel=noopener><img src=/images/tsqltues.png loading=lazy></a></p><p>Automation is something that interests me greatly, and I think if you have read even one of my previous posts youâ€™ll know that my favorite tool for this kind of work is PowerShell.Â  This is the perfect topic to kick off T-SQL Tuesday for 2019 so thanks goes to Garry Bargsley for hosting this month.</p><p>One of my goals for 2019 is to improve our server build process, itâ€™s currently reasonably well scripted but there are some definite gaps. Iâ€™ve started looking at using PowerShell Desired State Configuration (DSC) to install and configure SQL Server to both meet our needs and increase our speed and efficiency. Although full automation is a stretch goal for this project the DSC technology can certainly scale to accomplish that.</p><h3 id=powershell-desired-state-configuration>PowerShell Desired State Configuration</h3><p>PowerShell DSC is a platform to support the concept of Infrastructure as Code (IaC).Â  It uses declarative syntax instead of the usual imperative syntax of PowerShell.Â  This means that you describe your desired state rather than the specific steps needed to get there.Â  There are two modes for DSC, push and pull, although pull mode offers more features and scalability, weâ€™ll look at writing our configuration and using push mode for this blog post to keep it simple.</p><p>I hope that this blog post will be the first of a series this year as I work to finalize the full process of installing and configuring SQL Server with DSC. For now I will share step 1, ensuring the freshly built Windows OS meets the necessary prerequisites for the SQL Server installation.Â  Today weâ€™ll look at installing two Windows Features â€˜.NET 3.5 Featuresâ€™ and â€˜Active Directory module for Windows PowerShellâ€™ on our target node.</p><p>The first thing weâ€™ll want to do is to update the in-box DSC resources, PSDesiredStateConfiguration. This version comes with Windows PowerShell 4.0 and 5.0 however there have been notable improvements that we will want to take advantage of.Â  Since the updated module is available in the PowerShell Gallery we can install it to our workstation using the following (note the name change):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Install-Module PSDSCResources
</span></span></code></pre></td></tr></table></div></div><p>Since we are using the push mode we need to make sure any modules we use to write our configurations are available on our target nodes.Â  I have manually copied the <code>PSDSCResource</code> module to a path within the <code>$env:PSModulePath</code> on the target node so itâ€™ll be available when the configuration is enacted there. There are other ways to handle this including setting up a resource module file share.</p><h3 id=writing-our-first-configuration>Writing our First Configuration</h3><p>Weâ€™re now ready to write our first configuration, although we are still writing PowerShell the syntax is a little different.Â  One of my favorite things about PowerShell is using the command based help to discover how to execute new cmdlets and functions, DSC is no different here. We can use <code>Get-DscResource</code> to list all the resources we have available.</p><p><img src=/images/GetDscResource.jpg loading=lazy></p><p>Since we are going to use the WindowsFeature resource we can find out how to use that by passing in the <code>-Syntax</code> parameter to <code>Get-DscResource</code>.</p><p><img src=/images/WindowsFeatureSyntax.jpg loading=lazy></p><p>The only required parameter for the WindowsFeature resource is Name so weâ€™ll include that.Â  I also like to include the â€˜Ensureâ€™ parameter, it defaults to â€˜Presentâ€™ but I feel it makes it clearer to specifically define that.Â  I also want to set â€˜IncludeAllSubFeatureâ€™ to true so those get installed also.Â </p><p>The below code is all we need to get started with our first configuration. Apart from the resource blocks that we have already mentioned there are a couple of other important parts to note. First is the keyword <code>Configuration</code> which shows we are writing a DSC Configuration document. In this case Iâ€™ve named our configuration â€˜SQLServerPreReqâ€™. Secondly, the <code>Node</code> keyword is important, this defines the target node for our configuration.Â  Itâ€™s important to remember that this is a simple example, it is possible to pass in multiple node names or to parameterize that node name to make our configuration more useful.</p><p>The last line of code calls our SQLServerPreReq configuration and specifies the output path.Â  When you call a configuration a MOF file is created which is the document that will be sent to the target node and used to both enact the configuration and monitor for configuration drift (a feature of the pull mode that weâ€™ll save for a future post).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Configuration SQLServerPreReq {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Import-DscResource -ModuleName PSDSCResources
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Node &#39;DscSvr2&#39; {
</span></span><span class=line><span class=cl>        WindowsFeature dotNet
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl>            Name                    = &#39;NET-Framework-Features&#39;
</span></span><span class=line><span class=cl>            Ensure                  = &#39;Present&#39;
</span></span><span class=line><span class=cl>            IncludeAllSubFeature    = $true
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        WindowsFeature ADPowershell 
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl>            Name                    = &#39;RSAT-AD-PowerShell&#39;
</span></span><span class=line><span class=cl>            Ensure                  = &#39;Present&#39;
</span></span><span class=line><span class=cl>            IncludeAllSubFeature    = $true
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SQLServerPreReq -Output .\Output\ 
</span></span></code></pre></td></tr></table></div></div><p>Once we have our MOF file the final step is to enact our configuration against our target node.Â  Iâ€™m using the <code>-wait</code> and <code>-verbose</code> parameters so that the configuration doesnâ€™t run in the background and we can view the verbose messages on screen as it executes.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Start-DscConfiguration -Path .\Output\ -Wait -Verbose
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://jesspomfret.com/wp-content/uploads/2019/01/startDscConfiguration1-1.jpg target=_blank rel=noopener><img src=/images/startDscConfiguration1-1.jpg loading=lazy></a></p><p>Once this runs successfully you can confirm the features are installed using <code>Get-WindowsFeature</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Get-WindowsFeature -ComputerName dscsvr2 `
</span></span><span class=line><span class=cl>-Name @(&#39;RSAT-AD-PowerShell&#39;,&#39;NET-Framework-Features&#39;)
</span></span></code></pre></td></tr></table></div></div><p><img src=/images/GetWindowsFeature.jpg loading=lazy></p><h3 id=using-composite-resources>Using Composite Resources</h3><p>This simple configuration shows how you can install two windows features using PowerShell DSC, however it is rather redundant to have to specify separate resource blocks for each feature.Â  Since we updated our in-box DSC Resources to the newer PSDSCResources module we are able to use the new WindowsFeatureSet resource which is an example of a composite resource. We can review the syntax again using Get-DscResource:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Get-DscResource -Name WindowsFeatureSet -Syntax
</span></span></code></pre></td></tr></table></div></div><p>The main difference is that WindowsFeatureSet takes an array of features to install and then translates this to use multiple WindowsFeature resources when the MOF file is created.Â  This allows us to keep our configuration document as tidy and concise as possible.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Configuration SQLServerPreReq_v2 {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Import-DscResource -ModuleName PSDSCResources
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>    Node &#39;DscSvr2&#39; {
</span></span><span class=line><span class=cl>        WindowsFeatureSet PreReqFeatures
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl>            Name                    = @(&#39;NET-Framework-Features&#39;
</span></span><span class=line><span class=cl>                                        &#39;RSAT-AD-PowerShell&#39;)
</span></span><span class=line><span class=cl>            Ensure                  = &#39;Present&#39;
</span></span><span class=line><span class=cl>            IncludeAllSubFeature    = $true
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SQLServerPreReq_v2 -Output .\Output\ 
</span></span></code></pre></td></tr></table></div></div><p>Thatâ€™s step one towards automating my SQL Server builds, Iâ€™m looking forward to adding more to this series. Thanks again to Garry for picking the perfect T-SQL Tuesday topic to kick off the year with.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/automation/>automation</a>
<a href=/tags/dsc/>dsc</a>
<a href=/tags/powershell/>powershell</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/t-sql-tuesday-#108-non-sql-server-technologies/><div class=article-details><h2 class=article-title>T-SQL Tuesday #108 - Non SQL Server Technologies</h2></div></a></article><article><a href=/p/desired-state-configuration-a-few-warnings-when-using-psdscrunascredentials/><div class=article-details><h2 class=article-title>Desired State Configuration: A few warnings when using PSDscRunAsCredentials</h2></div></a></article><article><a href=/p/desired-state-configuration-troubleshooting-in-push-refresh-mode/><div class=article-details><h2 class=article-title>Desired State Configuration: Troubleshooting in Push Refresh Mode</h2></div></a></article><article><a href=/p/desired-state-configuration-resources/><div class=article-details><h2 class=article-title>Desired State Configuration: Resources</h2></div></a></article><article><a href=/p/desired-state-configuration-local-configuration-manager/><div class=article-details><h2 class=article-title>Desired State Configuration: Local Configuration Manager</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>