<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Recently I was tasked with troubleshooting an incident on a SQL Server at a certain point in the past, the issue being a high CPU alert.Â Itâ€™s hard (without monitoring solutions set up) to go back in time and determine what the issue is.Â However, one thing we can check is the windows event log to see if there was anything happening on the server at that time.
Now, you probably know that my favourite tool of choice is PowerShell, so let&amp;rsquo;s take a look at how we can use Get-WinEvent to see what was happening in the past."><title>Using Get-WinEvent to look into the past</title><link rel=canonical href=https://jpomfret.github.io/using-get-winevent-to-look-into-the-past/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="Using Get-WinEvent to look into the past"><meta property="og:description" content="Recently I was tasked with troubleshooting an incident on a SQL Server at a certain point in the past, the issue being a high CPU alert.Â Itâ€™s hard (without monitoring solutions set up) to go back in time and determine what the issue is.Â However, one thing we can check is the windows event log to see if there was anything happening on the server at that time.
Now, you probably know that my favourite tool of choice is PowerShell, so let&amp;rsquo;s take a look at how we can use Get-WinEvent to see what was happening in the past."><meta property="og:url" content="https://jpomfret.github.io/using-get-winevent-to-look-into-the-past/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="event-log"><meta property="article:tag" content="get-winevent"><meta property="article:tag" content="powershell"><meta property="article:published_time" content="2020-08-04T00:00:00+00:00"><meta property="article:modified_time" content="2020-08-04T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="Using Get-WinEvent to look into the past"><meta name=twitter:description content="Recently I was tasked with troubleshooting an incident on a SQL Server at a certain point in the past, the issue being a high CPU alert.Â Itâ€™s hard (without monitoring solutions set up) to go back in time and determine what the issue is.Â However, one thing we can check is the windows event log to see if there was anything happening on the server at that time.
Now, you probably know that my favourite tool of choice is PowerShell, so let&amp;rsquo;s take a look at how we can use Get-WinEvent to see what was happening in the past."><script async src="https://www.googletagmanager.com/gtag/js?id=G-YL15E7BXXF"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YL15E7BXXF",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#finding-some-logs>Finding some logs</a></li><li><a href=#filtering-events>Filtering events</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/powershell/>powershell</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/using-get-winevent-to-look-into-the-past/>Using Get-WinEvent to look into the past</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Aug 04, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><p>Recently I was tasked with troubleshooting an incident on a SQL Server at a certain point in the past, the issue being a high CPU alert.Â  Itâ€™s hard (without monitoring solutions set up) to go back in time and determine what the issue is.Â  However, one thing we can check is the windows event log to see if there was anything happening on the server at that time.</p><p>Now, you probably know that my favourite tool of choice is PowerShell, so let&rsquo;s take a look at how we can use <code>Get-WinEvent</code> to see what was happening in the past.</p><p><code>Get-WinEvent</code> is the newer revamped version of <code>Get-EventLog</code>, and there are two improvements I believe are worth mentioning. Firstly, with the introduction of filter parameters we can now find certain events much easier, which weâ€™ll talk about a little later. Secondly, the performance of <code>Get-WinEvent</code> is much faster than using the legacy command.Â  I believe this is due to the filtering happening at the event engine instead of within PowerShell.</p><h2 id=finding-some-logs>Finding some logs</h2><p>First things first, let&rsquo;s see what logs we have available on our target machine. Iâ€™m targeting a remote machine with the code below, but if weâ€™re investigating an issue on our local machine we can just exclude the <code>-ComputerName</code> parameter.</p><p>This snippet will output all of the logs on my remote machine that contain records to a gridview. I love to use <code>Out-GridView</code> for these kinds of tasks because this returned 101 logs and I can now add some text into the search bar to filter for things I might be interested in.</p><p>Get-WinEvent -ListLog * -ComputerName dscsvr2 |
Where-Object RecordCount |
Out-GridView</p><p>You can see if I add dsc into the search bar of <code>Out-Grid View</code> I have one log with records in that I could investigate further.</p><p><img src=/images/viewlogs.jpg loading=lazy alt="Out-GridView displaying results from Get-WinEvent -ListLog *"></p><h2 id=filtering-events>Filtering events</h2><p>I already mentioned this, but the new <code>Get-WinEvent</code> gives us three options for filtering events. Iâ€™ll show this example using <code>-FilterHashTable</code>, but just know there are two other options available, <code>-FilterXPath</code> and <code>-FilterXml</code>.</p><p>The full list of key/value pairs that we can use to filter on are under the <code>-FilterHashTable</code> parameter section of the <a class=link href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7" target=_blank rel=noopener>Microsoft Docs</a>. For now, weâ€™ll look at filtering based on log name and time.</p><p>So, say I have an alert for high CPU at 21:30 on 2020-07-31 and I want to know what was happening around that time on the server.</p><p>First Iâ€™ll set up a few parameters. Iâ€™m going to set the <code>$computerName</code> (I could add multiple here if I wanted to collect logs from more than one server) and the <code>$issueDateTime</code>. Iâ€™ve then also specified the <code>$windowMins</code>, Iâ€™m going to use to create a window of time around my issue to collect events for.</p><p>$computerName = &lsquo;dscsvr2&rsquo;
$issueDateTime = get-date(&lsquo;2020-07-31 21:30&rsquo;)
$windowMins = 30</p><p>Next weâ€™ll build the filter hash table. You can do this inline when you call the command, but I personally like to break it out just for readability.</p><p>$winEventFilterHash = @{
LogName = &lsquo;system&rsquo;,&lsquo;application&rsquo;
StartTime = $issueDateTime.AddMinutes(-($windowMins/2))
EndTime = $issueDateTime.AddMinutes(($windowMins/2))
}</p><p>Finally, weâ€™ll call <code>Get-WinEvent</code>, then pass in the filter hash table and the computer name.Â  Iâ€™m selecting just a few standard properties, as well as a calculated property to get the username instead of just the sid. The final piece of this pipeline is to use <code>Format-Table</code>. I would also recommend using Export-Excel to pipe it straight to an excel file for analysis.</p><p>(Note - I use Export-Excel in this post if you&rsquo;re interested in that - <a class=link href=https://jesspomfret.com/getting-versions/ target=_blank rel=noopener>Getting OS and SQL Version information with dbatools</a>)</p><p>Get-WinEvent -FilterHashtable $winEventFilterHash -ComputerName $computerName | Select-Object LogName,
ProviderName,
TimeCreated,
Id,
LevelDisplayName,
@{l=&lsquo;UserName&rsquo;;e={(New-Object System.Security.Principal.SecurityIdentifier($_.UserId)).Translate([System.Security.Principal.NTAccount])}},
Message | Format-Table</p><p>As you can see below, the results are returned from both the application and system logs along with the time, level, username and message.Â  Now, this is just a test box in my lab, but this is a great way of grabbing a window of events from your server to help troubleshoot issues in the past.</p><p><img src=/images/eventoutput.png loading=lazy alt="Results from Get-WinEvent"></p></section><footer class=article-footer><section class=article-tags><a href=/tags/event-log/>event-log</a>
<a href=/tags/get-winevent/>get-winevent</a>
<a href=/tags/powershell/>powershell</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/ad-powershell-domain/><div class=article-image><img src=/ad-powershell-domain/cover.1f6e3c7a515e11da6cb002af63610e16_hu13e3ae6f863033d0af17372d9ca75135_471265_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Run ActiveDirectory PowerShell commands against another domain" data-key=ad-powershell-domain data-hash="md5-H248elFeEdpssAKvY2EOFg=="></div><div class=article-details><h2 class=article-title>Run ActiveDirectory PowerShell commands against another domain</h2></div></a></article><article class=has-image><a href=/log-ship-staged/><div class=article-image><img src=/log-ship-staged/cover.f4ab6d164035c79e896561924d558d00_hufa84d3a6e624ae2b3ca125fbcc0da73a_679878_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Log Shipping â€“ Pre-stage database backups with dbatools" data-key=log-ship-staged data-hash="md5-9KttFkA1x56JZWGSTVWNAA=="></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article><article><a href=/collating-index-usage-stats-across-availability-group-replicas/><div class=article-details><h2 class=article-title>Collating index usage stats across Availability Group replicas</h2></div></a></article><article><a href=/t-sql-tuesday-#143-short-code-examples/><div class=article-details><h2 class=article-title>T-SQL Tuesday #143: Short code examples</h2></div></a></article><article><a href=/searching-stored-procedures-for-a-pattern-made-easy-with-dbatools/><div class=article-details><h2 class=article-title>Searching Stored Procedures for a pattern made easy with dbatools</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>