<!doctype html><html lang=en-gb dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="As soon as I saw Bert Wagner (t|b) post his T-SQL Tuesday topic last week I knew this was going to be a great one. Iâ€™m really looking forward to reading about everyoneâ€™s favorite code snippets so thanks Bert for hosting and choosing a fantastic subject!
A lot of the code I can&amp;rsquo;t live without is either downloaded from the community (e.g.Â sp_whoisactive, sp_indexinfo, sp_blitz), or very specific to my workplace so I&amp;rsquo;m going to share some code that I&amp;rsquo;ve been meaning to blog about."><title>T-SQL Tuesday #104 â€“ Code you can't live without</title><link rel=canonical href=https://jpomfret.github.io/t-sql-tuesday-#104-code-you-cant-live-without/><link rel=stylesheet href=/scss/style.min.3b122f5b6a7023e613be9affad843eaceacf4a3383edd177ce41e35501998968.css><meta property="og:title" content="T-SQL Tuesday #104 â€“ Code you can't live without"><meta property="og:description" content="As soon as I saw Bert Wagner (t|b) post his T-SQL Tuesday topic last week I knew this was going to be a great one. Iâ€™m really looking forward to reading about everyoneâ€™s favorite code snippets so thanks Bert for hosting and choosing a fantastic subject!
A lot of the code I can&amp;rsquo;t live without is either downloaded from the community (e.g.Â sp_whoisactive, sp_indexinfo, sp_blitz), or very specific to my workplace so I&amp;rsquo;m going to share some code that I&amp;rsquo;ve been meaning to blog about."><meta property="og:url" content="https://jpomfret.github.io/t-sql-tuesday-#104-code-you-cant-live-without/"><meta property="og:site_name" content="Jess Pomfret"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="data-compression"><meta property="article:tag" content="dbatools"><meta property="article:tag" content="powershell"><meta property="article:tag" content="t-sql-tuesday"><meta property="article:published_time" content="2018-07-10T00:00:00+00:00"><meta property="article:modified_time" content="2018-07-10T00:00:00+00:00"><meta name=twitter:site content="@jpomfret"><meta name=twitter:creator content="@jpomfret"><meta name=twitter:title content="T-SQL Tuesday #104 â€“ Code you can't live without"><meta name=twitter:description content="As soon as I saw Bert Wagner (t|b) post his T-SQL Tuesday topic last week I knew this was going to be a great one. Iâ€™m really looking forward to reading about everyoneâ€™s favorite code snippets so thanks Bert for hosting and choosing a fantastic subject!
A lot of the code I can&amp;rsquo;t live without is either downloaded from the community (e.g.Â sp_whoisactive, sp_indexinfo, sp_blitz), or very specific to my workplace so I&amp;rsquo;m going to share some code that I&amp;rsquo;ve been meaning to blog about."></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue9d3f1fdfff07cb5f7aa0c4e4da11a16_12179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ðŸ¦„</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jess Pomfret</a></h1><h2 class=site-description>Database Engineer with a Passion for Automation</h2></div></header><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/data-compression/>data-compression</a>
<a href=/categories/dbatools/>dbatools</a>
<a href=/categories/t-sql-tuesday/>t-sql-tuesday</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/t-sql-tuesday-#104-code-you-cant-live-without/>T-SQL Tuesday #104 â€“ Code you can't live without</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jul 10, 2018</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>3 minute read</time></div></footer></div></header><section class=article-content><p><a class=link href=https://bertwagner.com/2018/07/03/code-youd-hate-to-live-without-t-sql-tuesday-104-invitation/ target=_blank rel=noopener><img src=/images/tsqltues-300x300.png loading=lazy></a>As soon as I saw Bert Wagner (<a class=link href=https://twitter.com/bertwagner target=_blank rel=noopener>t</a>|<a class=link href=https://bertwagner.com/ target=_blank rel=noopener>b</a>) post his T-SQL Tuesday topic last week I knew this was going to be a great one. Iâ€™m really looking forward to reading about everyoneâ€™s favorite code snippets so thanks Bert for hosting and choosing a fantastic subject!</p><p>A lot of the code I can&rsquo;t live without is either downloaded from the community (e.g.Â <a class=link href=http://whoisactive.com/ target=_blank rel=noopener>sp_whoisactive</a>, <a class=link href=http://karaszi.com/spindexinfo-enhanced-index-information-procedure target=_blank rel=noopener>sp_indexinfo</a>, <a class=link href=https://www.brentozar.com/blitz/ target=_blank rel=noopener>sp_blitz</a>), or very specific to my workplace so I&rsquo;m going to share some code that I&rsquo;ve been meaning to blog about.</p><p>Iâ€™ve been using this at work recently and it also relates to the presentation I gave at the <a class=link href=http://jesspomfret.com/first-user-group-presentation-i-survived/ target=_blank rel=noopener>ONSSUG June meeting</a> around data compression. The beginnings of this script originated online as I dug into learning about the DMVs that related to objects and compression and then customized for what I needed.</p><p>If you run the below as is it will provide basic information about all objects in your database, except those in the &lsquo;sys&rsquo; schema, along with their current size and compression level.</p><p>SELECT
schema_name(obj.SCHEMA_ID) as SchemaName,
obj.name as TableName,
ind.name as IndexName,
ind.type_desc as IndexType,
pas.row_count as NumberOfRows,
pas.used_page_count as UsedPageCount,
(pas.used_page_count * 8)/1024 as SizeUsedMB,
par.data_compression_desc as DataCompression
FROM sys.objects obj
INNER JOIN sys.indexes ind
ON obj.object_id = ind.object_id
INNER JOIN sys.partitions par
ON par.index_id = ind.index_id
AND par.object_id = obj.object_id
INNER JOIN sys.dm_db_partition_stats pas
ON pas.partition_id = par.partition_id
WHERE obj.schema_id &lt;> 4 &ndash; exclude objects in &lsquo;sys&rsquo; schema
&ndash;AND schema_name(obj.schema_id) = &lsquo;schemaName&rsquo;
&ndash;AND obj.name = &rsquo;tableName&rsquo;
ORDER BY SizeUsedMB desc</p><p>(This is also available in my <a class=link href=https://github.com/jpomfret/ScriptsAndTips/blob/master/ObjectSizeAndCompression.sql target=_blank rel=noopener>GitHub Tips and Scripts Repo</a>)</p><p>Now this T-SQL is great for a quick look at one database, but what if I want to run this script against every database in my environment? Well I popped over to PowerShell, fired up <a class=link href=http://dbatools.io/ target=_blank rel=noopener>dbatools</a> and ran the following:</p><p>get-command -Module dbatools -Name *compression*</p><p>Bad news, there was no Get-DbaDbCompression, there were commands for compressing objects (Set-DbaDbCompression) and for getting suggested compression setting based on the <a class=link href=https://blogs.msdn.microsoft.com/blogdoezequiel/2011/01/03/the-sql-swiss-army-knife-6-evaluating-compression-gains/ target=_blank rel=noopener>Tiger Teams best practices</a> (Test-DbaDbCompression), but nothing to just return the current compression status of the objects.</p><p>Whatâ€™s more exciting than just using the greatest PowerShell module ever created? Making it better by contributing! So I made sure I had the latest development branch synced up and got to work writing Get-DbaDbCompression.Â  This has now been merged into the main branch and is therefore available in the Powershell gallery, so if your dbatools module is up to date you can now run the following to get the same information as above from one database:</p><p>Get-DbaDbCompression -SqlInstance serverName -Database databaseName</p><p>Or go crazy and run it against a bunch of servers.</p><p>$servers = Get-DbaRegisteredServer -SqlInstance cmsServer | select -expand servername
$compression = Get-DbaDbCompression -SqlInstance $servers
$compression | Out-GridView</p><p>I hope this post might come in handy for anyone who is curious about data compression in their environments. Both the T-SQL and PowerShell versions provide not just the current compression setting but the size of the object too. Useful if you are about to apply compression and would like a before and after comparison to see how much space you saved.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/data-compression/>data-compression</a>
<a href=/tags/dbatools/>dbatools</a>
<a href=/tags/powershell/>powershell</a>
<a href=/tags/t-sql-tuesday/>t-sql-tuesday</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/t-sql-tuesday-#135-the-outstanding-tools-of-the-trade-that-make-your-job-awesome/><div class=article-details><h2 class=article-title>T-SQL Tuesday #135: The outstanding tools of the trade that make your job awesome</h2></div></a></article><article class=has-image><a href=/log-ship-staged/><div class=article-image><img src=/log-ship-staged/cover.f4ab6d164035c79e896561924d558d00_hufa84d3a6e624ae2b3ca125fbcc0da73a_679878_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post Log Shipping â€“ Pre-stage database backups with dbatools" data-key=log-ship-staged data-hash="md5-9KttFkA1x56JZWGSTVWNAA=="></div><div class=article-details><h2 class=article-title>Log Shipping â€“ Pre-stage database backups with dbatools</h2></div></a></article><article><a href=/collating-index-usage-stats-across-availability-group-replicas/><div class=article-details><h2 class=article-title>Collating index usage stats across Availability Group replicas</h2></div></a></article><article><a href=/t-sql-tuesday-#143-short-code-examples/><div class=article-details><h2 class=article-title>T-SQL Tuesday #143: Short code examples</h2></div></a></article><article><a href=/searching-stored-procedures-for-a-pattern-made-easy-with-dbatools/><div class=article-details><h2 class=article-title>Searching Stored Procedures for a pattern made easy with dbatools</h2></div></a></article></div></div></aside><div class=disqus-container></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Jess Pomfret</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.15.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>